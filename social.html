<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î–æ—Å–∫–∞ –ü–æ–∑–æ—Ä–∞ ‚Äî –°–æ—Ü—Å–µ—Ç—å</title>
    <link rel="icon" type="image/png" href="img/ico.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f0f;
            --bg2: #161616;
            --bg3: #1e1e1e;
            --bg4: #262626;
            --border: #2a2a2a;
            --accent: #1d9bf0;
            --accent2: #8b5cf6;
            --text: #e7e9ea;
            --text2: #71767b;
            --danger: #f4212e;
            --green: #00ba7c;
            --gold: #ffd700;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* ===== LAYOUT ===== */
        .layout {
            display: flex;
            max-width: 1280px;
            margin: 0 auto;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 260px;
            min-width: 260px;
            padding: 16px 12px;
            position: sticky;
            top: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
        }
        .logo-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 12px 28px;
        }
        .logo-emoji { font-size: 1.6rem; }
        .logo-text {
            font-size: 1.05rem;
            font-weight: 800;
            color: var(--text);
        }
        .logo-back {
            margin-left: auto;
            background: var(--bg3);
            border: 1px solid var(--border);
            color: var(--text2);
            border-radius: 20px;
            padding: 7px 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .logo-back:hover { color: var(--text); background: var(--bg4); }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 13px 16px;
            border-radius: 50px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text);
            font-size: 1rem;
            font-weight: 500;
            font-family: 'Inter', sans-serif;
            width: 100%;
            text-align: left;
            transition: background 0.15s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.06); }
        .nav-item.active { font-weight: 700; }
        .nav-item.active .nav-icon { color: var(--accent); }
        .nav-icon { font-size: 1.2rem; width: 24px; text-align: center; }

        .nav-divider { height: 1px; background: var(--border); margin: 10px 0; }

        .user-chip {
            margin-top: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 50px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .user-chip:hover { background: rgba(255,255,255,0.06); }
        .user-chip-avatar {
            width: 38px; height: 38px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg4);
        }
        .user-chip-name { font-weight: 600; font-size: 0.9rem; flex: 1; }
        .user-chip-handle { color: var(--text2); font-size: 0.78rem; }
        .user-chip-dots { color: var(--text2); font-size: 1.1rem; }

        /* ===== MAIN FEED ===== */
        .main-feed {
            flex: 1;
            max-width: 600px;
            border-right: 1px solid var(--border);
            min-height: 100vh;
        }
        .feed-header {
            position: sticky;
            top: 0;
            background: rgba(15,15,15,0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .feed-header-title {
            padding: 16px 20px;
            font-size: 1.1rem;
            font-weight: 800;
        }
        .feed-tabs {
            display: flex;
        }
        .feed-tab {
            flex: 1;
            text-align: center;
            padding: 14px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text2);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.15s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            color: var(--text2);
            font-family: 'Inter', sans-serif;
        }
        .feed-tab:hover { background: rgba(255,255,255,0.04); color: var(--text); }
        .feed-tab.active { color: var(--text); font-weight: 700; border-bottom-color: var(--accent); }

        /* ===== POST COMPOSER ===== */
        .composer {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
        }
        .composer-avatar {
            width: 42px; height: 42px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg4);
            flex-shrink: 0;
        }
        .composer-right { flex: 1; }
        .composer-textarea {
            width: 100%;
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.1rem;
            font-family: 'Inter', sans-serif;
            resize: none;
            min-height: 60px;
            outline: none;
            padding: 8px 0;
        }
        .composer-textarea::placeholder { color: var(--text2); }
        .composer-divider { height: 1px; background: var(--border); margin: 8px 0; }
        .composer-bottom {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .composer-tools { display: flex; gap: 4px; }
        .composer-tool-btn {
            width: 42px; height: 42px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg3);
            color: var(--text);
            font-size: 0; /* hide emoji fallback */
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .composer-tool-btn svg { width: 20px; height: 20px; }
        .composer-tool-btn:hover { background: var(--bg4); border-color: var(--text2); color: var(--text); transform: scale(1.08); }
        .composer-right-tools { display: flex; align-items: center; gap: 10px; }
        .char-counter { color: var(--text2); font-size: 0.8rem; }
        .char-counter.warn { color: #ffd700; }
        .char-counter.danger { color: var(--danger); }
        .post-btn {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 50px;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: background 0.15s;
        }
        .post-btn:hover { background: #1a8cd8; }
        .post-btn:disabled { background: #1d4a6e; color: #71767b; cursor: not-allowed; }

        /* ===== POST CARD ===== */
        .post-card {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            cursor: pointer;
            transition: background 0.1s;
        }
        .post-card:hover { background: rgba(255,255,255,0.02); }
        .post-avatar {
            width: 42px; height: 42px;
            border-radius: 50%;
            object-fit: cover;
            background: var(--bg4);
            flex-shrink: 0;
            cursor: pointer;
        }
        .post-right { flex: 1; min-width: 0; }
        .post-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            flex-wrap: wrap;
        }
        .post-name {
            font-weight: 700;
            font-size: 0.95rem;
            cursor: pointer;
        }
        .post-name:hover { text-decoration: underline; }
        .post-handle {
            color: var(--text2);
            font-size: 0.88rem;
        }
        .post-dot { color: var(--text2); font-size: 0.7rem; }
        .post-time { color: var(--text2); font-size: 0.85rem; }
        .post-more {
            margin-left: auto;
            width: 32px; height: 32px;
            border-radius: 50%;
            border: none;
            background: none;
            color: var(--text2);
            font-size: 1.1rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.15s;
        }
        .post-more:hover { background: rgba(29,155,240,0.1); color: var(--accent); }
        .post-text {
            font-size: 0.97rem;
            line-height: 1.6;
            margin-bottom: 10px;
            word-break: break-word;
            white-space: pre-wrap;
        }
        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 14px;
            border: 1px solid var(--border);
            margin-bottom: 10px;
        }
        .post-actions {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }
        .action-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            border-radius: 50px;
            border: none;
            background: none;
            color: var(--text2);
            font-size: 0.82rem;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: all 0.15s;
            min-width: 52px;
        }
        .action-btn:hover.like { color: var(--danger); background: rgba(244,33,46,0.08); }
        .action-btn:hover.comment { color: var(--accent); background: rgba(29,155,240,0.08); }
        .action-btn:hover.repost { color: var(--green); background: rgba(0,186,124,0.08); }
        .action-btn:hover.views { color: var(--text); background: rgba(255,255,255,0.05); }
        .action-btn.liked { color: var(--danger); }
        .action-btn.liked:hover { background: rgba(244,33,46,0.08); }
        .action-icon { font-size: 1rem; }

        /* ===== RIGHT PANEL ===== */
        .right-panel {
            width: 340px;
            min-width: 340px;
            padding: 16px;
        }
        .search-box {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 10px 16px;
            margin-bottom: 16px;
        }
        .search-box-icon { color: var(--text2); }
        .search-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
        }
        .search-input::placeholder { color: var(--text2); }

        .widget {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .widget-title {
            font-size: 1.1rem;
            font-weight: 800;
            margin-bottom: 14px;
        }

        .suggest-user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .suggest-user:last-child { border-bottom: none; }
        .suggest-avatar {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--bg4);
            object-fit: cover;
            font-size: 1.3rem;
            display: flex; align-items: center; justify-content: center;
        }
        .suggest-info { flex: 1; }
        .suggest-name { font-weight: 700; font-size: 0.9rem; }
        .suggest-handle { color: var(--text2); font-size: 0.8rem; }
        .follow-btn {
            background: var(--text);
            color: var(--bg);
            border: none;
            border-radius: 50px;
            padding: 6px 16px;
            font-size: 0.83rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: opacity 0.15s;
        }
        .follow-btn:hover { opacity: 0.85; }
        .follow-btn.following {
            background: none;
            color: var(--text);
            border: 1px solid var(--border);
        }
        .follow-btn.following:hover { border-color: var(--danger); color: var(--danger); background: rgba(244,33,46,0.08); }

        /* ===== PROFILE VIEW ===== */
        #profileView {
            display: none;
        }
        .profile-banner {
            height: 140px;
            background: linear-gradient(135deg, #1d4a6e, #3b2060, #1a1a2e);
            position: relative;
            z-index: 0;
        }
        .profile-banner-edit {
            position: absolute;
            top: 10px; right: 10px;
            background: rgba(0,0,0,0.5);
            border: none;
            border-radius: 50%;
            width: 36px; height: 36px;
            color: #fff;
            cursor: pointer;
            font-size: 1rem;
            display: flex; align-items: center; justify-content: center;
        }
        .profile-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }
        .profile-avatar-row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            margin-top: -44px;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }
        .profile-avatar {
            width: 88px; height: 88px;
            border-radius: 50%;
            border: 4px solid var(--bg);
            object-fit: cover;
            background: var(--bg4);
            font-size: 2.5rem;
            display: flex; align-items: center; justify-content: center;
        }
        .profile-edit-btn {
            background: none;
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 8px 20px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: background 0.15s;
        }
        .profile-edit-btn:hover { background: rgba(255,255,255,0.06); }
        .profile-name { font-size: 1.3rem; font-weight: 800; }
        .profile-handle { color: var(--text2); font-size: 0.9rem; margin-bottom: 10px; }
        .profile-bio { font-size: 0.95rem; margin-bottom: 10px; line-height: 1.5; }
        .profile-meta { display: flex; gap: 16px; color: var(--text2); font-size: 0.85rem; margin-bottom: 10px; }
        .profile-stats { display: flex; gap: 20px; font-size: 0.9rem; }
        .profile-stats span:hover .profile-stat-label { color: var(--text); }
        .profile-stats span:hover .profile-stat-val { text-decoration: underline; }
        .profile-stat-val { font-weight: 700; }
        .profile-stat-label { color: var(--text2); }

        .profile-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }
        .profile-tab {
            flex: 1;
            text-align: center;
            padding: 16px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text2);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            font-family: 'Inter', sans-serif;
            transition: all 0.15s;
        }
        .profile-tab:hover { background: rgba(255,255,255,0.04); color: var(--text); }
        .profile-tab.active { color: var(--text); font-weight: 700; border-bottom-color: var(--accent); }

        /* ===== MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            width: 90%;
            max-width: 540px;
            max-height: 85vh;
            overflow-y: auto;
            animation: modal-in 0.2s ease;
        }
        @keyframes modal-in {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .modal-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 1;
        }
        .modal-close {
            width: 34px; height: 34px;
            border-radius: 50%;
            border: none;
            background: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.15s;
        }
        .modal-close:hover { background: rgba(255,255,255,0.08); }
        .modal-title { font-size: 1.05rem; font-weight: 800; }
        .modal-body { padding: 16px; }

        /* ===== EDIT PROFILE MODAL ===== */
        .edit-field { margin-bottom: 16px; }
        .edit-label { font-size: 0.8rem; color: var(--text2); margin-bottom: 6px; font-weight: 500; }
        .edit-input, .edit-textarea {
            width: 100%;
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            padding: 10px 12px;
            outline: none;
            transition: border-color 0.15s;
        }
        .edit-input:focus, .edit-textarea:focus { border-color: var(--accent); }
        .edit-textarea { resize: vertical; min-height: 80px; }
        .edit-save-btn {
            background: var(--text);
            color: var(--bg);
            border: none;
            border-radius: 50px;
            padding: 10px 24px;
            font-size: 0.95rem;
            font-weight: 800;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
        }
        .edit-save-btn:hover { opacity: 0.85; }

        /* ===== POST DETAIL MODAL ===== */
        .comment-input-row {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-top: 1px solid var(--border);
        }
        .comment-input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: var(--text);
            font-size: 0.95rem;
            font-family: 'Inter', sans-serif;
            resize: none;
            min-height: 48px;
        }
        .comment-input::placeholder { color: var(--text2); }
        .comment-send-btn {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 50px;
            padding: 8px 18px;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            align-self: flex-end;
        }
        .comment-card {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .comment-avatar {
            width: 38px; height: 38px;
            border-radius: 50%;
            background: var(--bg4);
            object-fit: cover;
            font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
        }
        .comment-body { flex: 1; }
        .comment-name { font-weight: 700; font-size: 0.88rem; }
        .comment-handle { color: var(--text2); font-size: 0.8rem; }
        .comment-text { font-size: 0.92rem; margin-top: 4px; line-height: 1.5; }

        /* ===== TOAST ===== */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: var(--text);
            color: var(--bg);
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 9999;
            transition: transform 0.3s ease;
            pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* ===== LOADING ===== */
        .feed-loading {
            text-align: center;
            padding: 40px;
            color: var(--text2);
        }
        .spinner-small {
            width: 28px; height: 28px;
            border: 3px solid var(--bg4);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text2);
        }
        .empty-state-icon { font-size: 3rem; margin-bottom: 12px; }
        .empty-state-title { font-size: 1.2rem; font-weight: 800; color: var(--text); margin-bottom: 8px; }
        .empty-state-sub { font-size: 0.9rem; line-height: 1.5; }

        /* ===== AUTH WALL ===== */
        .auth-wall {
            padding: 60px 20px;
            text-align: center;
        }
        .auth-wall-title { font-size: 1.8rem; font-weight: 800; margin-bottom: 10px; }
        .auth-wall-sub { color: var(--text2); margin-bottom: 24px; font-size: 0.95rem; }
        .google-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: var(--text);
            color: var(--bg);
            border: none;
            border-radius: 50px;
            padding: 12px 28px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            transition: opacity 0.15s;
        }
        .google-btn:hover { opacity: 0.85; }

        /* ===== USERNAME SETUP ===== */
        .username-setup {
            display: none;
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 5000;
            align-items: center;
            justify-content: center;
        }
        .username-setup.open { display: flex; }
        .username-setup-box {
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .username-setup-title { font-size: 1.4rem; font-weight: 800; margin-bottom: 8px; }
        .username-setup-sub { color: var(--text2); font-size: 0.9rem; margin-bottom: 24px; }
        .username-setup-input {
            width: 100%;
            background: var(--bg3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            padding: 12px 16px;
            outline: none;
            margin-bottom: 12px;
            transition: border-color 0.15s;
        }
        .username-setup-input:focus { border-color: var(--accent); }
        .username-error { color: var(--danger); font-size: 0.85rem; margin-bottom: 12px; min-height: 20px; }
        .username-submit {
            width: 100%;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 50px;
            padding: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
        }
        .username-submit:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: #2a2a2a;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #3a3a3a;
        }
        * { scrollbar-width: thin; scrollbar-color: #2a2a2a transparent; }


        /* ===== VOICE MESSAGE ===== */
        .voice-msg-player {
            display: flex; align-items: center; gap: 10px;
            background: rgba(255,255,255,0.06); border-radius: 20px;
            padding: 8px 14px; min-width: 180px; max-width: 260px;
        }
        .voice-msg-play {
            width: 34px; height: 34px; border-radius: 50%;
            background: var(--accent); border: none; color: #fff;
            font-size: 0.85rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; transition: background 0.15s;
        }
        .voice-msg-play:hover { background: #1a8cd8; }
        .voice-msg-wave { flex: 1; height: 28px; display: flex; align-items: center; gap: 2px; }
        .voice-msg-wave span { display: inline-block; width: 3px; border-radius: 2px; background: var(--accent); opacity: 0.7; }
        .voice-msg-duration { font-size: 0.75rem; color: var(--text2); min-width: 30px; text-align: right; }
        .voice-preview-bar {
            display: flex; align-items: center; gap: 10px;
            background: var(--bg3); border: 1px solid var(--border);
            border-radius: 20px; padding: 8px 14px; margin-top: 8px;
        }

        /* ===== ADMIN PANEL ===== */
        #adminView { display: none; }
        .admin-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--bg); }
        .admin-tab {
            flex: 1; padding: 12px; text-align: center; font-size: 0.85rem; font-weight: 500;
            color: var(--text2); cursor: pointer; border: none; background: none;
            border-bottom: 3px solid transparent; font-family: Inter, sans-serif; transition: all 0.15s;
        }
        .admin-tab:hover { color: var(--text); background: rgba(255,255,255,0.03); }
        .admin-tab.active { color: var(--text); font-weight: 700; border-bottom-color: var(--accent2); }
        .admin-section { padding: 16px 20px; }
        .admin-card { background: var(--bg2); border: 1px solid var(--border); border-radius: 14px; padding: 16px; margin-bottom: 12px; }
        .admin-card-title { font-weight: 700; font-size: 0.75rem; margin-bottom: 10px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.05em; }
        .admin-stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
        .admin-stat-row:last-child { border-bottom: none; }
        .admin-stat-val { font-size: 1.4rem; font-weight: 800; color: var(--accent); }
        .admin-user-row { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .admin-user-row:last-child { border-bottom: none; }
        .admin-danger-btn { background: none; border: 1px solid var(--danger); color: var(--danger); border-radius: 20px; padding: 4px 12px; font-size: 0.78rem; font-weight: 600; cursor: pointer; font-family: Inter, sans-serif; transition: all 0.15s; }
        .admin-danger-btn:hover { background: rgba(244,33,46,0.1); }
        .admin-info-btn { background: none; border: 1px solid var(--accent); color: var(--accent); border-radius: 20px; padding: 4px 12px; font-size: 0.78rem; font-weight: 600; cursor: pointer; font-family: Inter, sans-serif; transition: all 0.15s; margin-right: 4px; }
        .admin-info-btn:hover { background: rgba(29,155,240,0.1); }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 1100px) {
            .right-panel { display: none; }
        }
        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ */
        .mobile-back-bar {
            display: none;
        }
        @media (max-width: 680px) {
            .mobile-back-bar {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 10px 16px;
                background: rgba(15,15,15,0.95);
                border-bottom: 1px solid var(--border);
                position: sticky;
                top: 0;
                z-index: 100;
                backdrop-filter: blur(12px);
            }
            .mobile-back-btn {
                display: flex;
                align-items: center;
                gap: 6px;
                background: var(--bg3);
                border: 1px solid var(--border);
                color: var(--text);
                border-radius: 20px;
                padding: 7px 16px;
                font-size: 0.88rem;
                font-weight: 600;
                cursor: pointer;
                text-decoration: none;
                transition: all 0.2s;
                font-family: 'Inter', sans-serif;
            }
            .mobile-back-btn:hover { background: var(--bg4); }
            .mobile-back-title {
                font-size: 1rem;
                font-weight: 800;
                color: var(--text);
            }

            .sidebar { width: 60px; min-width: 60px; padding: 10px 6px; }
            .logo-text, .logo-back, .nav-item span:not(.nav-icon), .user-chip-info { display: none; }
            .nav-item { justify-content: center; padding: 13px; }
            .user-chip { padding: 8px; justify-content: center; }
            .main-feed { max-width: 100%; border-right: none; }
            .logo-row { justify-content: center; padding: 10px 0 20px; }
            /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ sticky back-bar */
            .layout { padding-top: 0; }
        }
    </style>
</head>
<body>

<!-- USERNAME SETUP OVERLAY -->
<div class="username-setup" id="usernameSetup">
    <div class="username-setup-box">
        <div style="font-size:2rem;margin-bottom:12px;">ü§°</div>
        <div class="username-setup-title">–ü—Ä–∏–¥—É–º–∞–π —é–∑–µ—Ä–Ω–µ–π–º</div>
        <div class="username-setup-sub">–ë—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞–∫ @username. –ò–∑–º–µ–Ω–∏—Ç—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–∑–∂–µ.</div>
        <input type="text" class="username-setup-input" id="usernameInput" placeholder="—Ç–æ–ª—å–∫–æ_–±—É–∫–≤—ã_—Ü–∏—Ñ—Ä—ã_–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ" maxlength="20">
        <div class="username-error" id="usernameError"></div>
        <button class="username-submit" id="usernameSubmit" onclick="submitUsername()">–ì–æ—Ç–æ–≤–æ</button>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FOLLOW LIST MODAL -->
<div class="modal-overlay" id="followListModal">
    <div class="modal">
        <div class="modal-header">
            <button class="modal-close" onclick="closeModal('followListModal')">‚úï</button>
            <div class="modal-title" id="followListTitle">–ü–æ–¥–ø–∏—Å–∫–∏</div>
        </div>
        <div class="modal-body" id="followListBody" style="padding:0;"></div>
    </div>
</div>

<!-- PHOTO LIGHTBOX -->
<div id="photoLightbox" onclick="closeLightbox()" style="
    display:none;position:fixed;inset:0;z-index:9999;
    background:rgba(0,0,0,0.92);backdrop-filter:blur(8px);
    align-items:center;justify-content:center;cursor:zoom-out;
">
    <button onclick="event.stopPropagation();closeLightbox()" style="
        position:absolute;top:16px;right:20px;background:rgba(255,255,255,0.12);
        border:none;color:#fff;font-size:1.4rem;width:40px;height:40px;border-radius:50%;
        cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1;
    ">‚úï</button>
    <button id="lbPrev" onclick="event.stopPropagation();lightboxNav(-1)" style="
        position:absolute;left:16px;top:50%;transform:translateY(-50%);
        background:rgba(255,255,255,0.12);border:none;color:#fff;font-size:1.5rem;
        width:44px;height:44px;border-radius:50%;cursor:pointer;display:none;
        align-items:center;justify-content:center;
    ">‚Äπ</button>
    <img id="lightboxImg" style="max-width:96vw;max-height:92vh;border-radius:8px;object-fit:contain;pointer-events:none;display:block;" src="">
    <button id="lbNext" onclick="event.stopPropagation();lightboxNav(1)" style="
        position:absolute;right:16px;top:50%;transform:translateY(-50%);
        background:rgba(255,255,255,0.12);border:none;color:#fff;font-size:1.5rem;
        width:44px;height:44px;border-radius:50%;cursor:pointer;display:none;
        align-items:center;justify-content:center;
    ">‚Ä∫</button>
    <div id="lbCounter" style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:rgba(255,255,255,0.6);font-size:0.85rem;"></div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal-overlay" id="editProfileModal">
    <div class="modal">
        <div class="modal-header">
            <button class="modal-close" onclick="closeModal('editProfileModal')">‚úï</button>
            <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</div>
            <div style="margin-left:auto;">
                <button class="edit-save-btn" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="edit-field">
                <div class="edit-label">–ò–º—è</div>
                <input type="text" class="edit-input" id="editName" maxlength="50" placeholder="–¢–≤–æ—ë –∏–º—è">
            </div>
            <div class="edit-field">
                <div class="edit-label">Bio</div>
                <textarea class="edit-textarea" id="editBio" maxlength="160" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..."></textarea>
            </div>
            <div class="edit-field">
                <div class="edit-label">–ê–≤–∞—Ç–∞—Ä–∫–∞ (URL)</div>
                <input type="text" class="edit-input" id="editAvatar" placeholder="https://...">
            </div>
        </div>
    </div>
</div>

<!-- POST DETAIL MODAL -->
<div class="modal-overlay" id="postDetailModal">
    <div class="modal">
        <div class="modal-header">
            <button class="modal-close" onclick="closeModal('postDetailModal')">‚úï</button>
            <div class="modal-title">–ü–æ—Å—Ç</div>
        </div>
        <div class="modal-body" id="postDetailBody">
        </div>
    </div>
</div>

<!-- MAIN LAYOUT -->
<!-- –ú–û–ë–ò–õ–¨–ù–ê–Ø –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î (—Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ) -->
<div class="mobile-back-bar">
    <a href="index.html" class="mobile-back-btn">‚Üê –ù–∞–∑–∞–¥</a>
    <span class="mobile-back-title">üåê –°–æ—Ü—Å–µ—Ç—å</span>
</div>

<div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="logo-row">
            <span class="logo-emoji">ü§°</span>
            <span class="logo-text">–î–æ—Å–∫–∞ –ü–æ–∑–æ—Ä–∞</span>
            <a href="index.html" class="logo-back">‚Üê –ù–∞–∑–∞–¥</a>
        </div>

        <button class="nav-item active" id="navFeed" onclick="showFeed()">
            <span class="nav-icon">üè†</span>
            <span>–õ–µ–Ω—Ç–∞</span>
        </button>
        <button class="nav-item" id="navChat" onclick="showChat()">
            <span class="nav-icon">üí¨</span>
            <span>–ß–∞—Ç</span>
        </button>
        <button class="nav-item" id="navSearch" onclick="showSearch()">
            <span class="nav-icon">üîç</span>
            <span>–ü–æ–∏—Å–∫</span>
        </button>
        <button class="nav-item" id="navProfile" onclick="showMyProfile()">
            <span class="nav-icon">üë§</span>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
        <button class="nav-item" id="navAdmin" onclick="showAdmin()" style="display:none;">
            <span class="nav-icon">üîß</span>
        </button>

        <div class="nav-divider"></div>

        <div class="user-chip" id="sidebarUserChip" onclick="showMyProfile()">
            <img src="img/ico2.png" id="sidebarAvatar" class="user-chip-avatar" alt="av">
            <div class="user-chip-info">
                <div class="user-chip-name" id="sidebarName">–ì–æ—Å—Ç—å</div>
                <div class="user-chip-handle" id="sidebarHandle">@–≥–æ—Å—Ç—å</div>
            </div>
            <span class="user-chip-dots">¬∑¬∑¬∑</span>
        </div>
    </aside>

    <!-- MAIN FEED -->
    <main class="main-feed" id="mainFeedArea">
        <!-- FEED VIEW -->
        <div id="feedView">
            <div class="feed-header">
                <div class="feed-header-title">–õ–µ–Ω—Ç–∞</div>
                <div class="feed-tabs">
                    <button class="feed-tab active" id="tabForYou" onclick="switchFeedTab('forYou')">–î–ª—è –≤–∞—Å</button>
                    <button class="feed-tab" id="tabFollowing" onclick="switchFeedTab('following')">–ü–æ–¥–ø–∏—Å–∫–∏</button>
                </div>
            </div>

            <div class="composer" id="composer">
                <img src="img/ico2.png" id="composerAvatar" class="composer-avatar" alt="av">
                <div class="composer-right">
                    <textarea class="composer-textarea" id="postText" placeholder="–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?" maxlength="500" oninput="updateCharCounter()"></textarea>
                    <!-- Photo preview -->
                    <div id="photoPreviewRow" style="display:none;flex-wrap:wrap;gap:8px;margin:8px 0;"></div>
                    <!-- Voice preview for post -->
                    <div id="voicePostPreviewBar" style="display:none;align-items:center;gap:10px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:10px 14px;margin:8px 0;">
                        <span id="voicePostTimer" style="color:var(--danger);font-size:0.85rem;font-weight:700;min-width:36px;">‚óè 0:00</span>
                        <span style="flex:1;color:var(--text2);font-size:0.85rem;">–ò–¥—ë—Ç –∑–∞–ø–∏—Å—å...</span>
                        <button onclick="stopVoicePost(true)" style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:5px 14px;font-size:0.82rem;cursor:pointer;font-weight:600;">‚úì –°—Ç–æ–ø</button>
                        <button onclick="stopVoicePost(false)" style="background:var(--bg4);color:var(--text2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-size:0.82rem;cursor:pointer;">‚úï</button>
                    </div>
                    <div id="voicePostAttachedBar" style="display:none;align-items:center;gap:10px;background:var(--bg3);border:1px solid var(--border);border-radius:12px;padding:10px 14px;margin:8px 0;">
                        <span>üéôÔ∏è</span>
                        <audio id="voicePostAudioEl" controls style="flex:1;height:32px;"></audio>
                        <button onclick="cancelVoicePost()" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:1rem;">‚úï</button>
                    </div>
                    <!-- Poll UI -->
                    <div id="pollSection" style="display:none;border:1px solid var(--border);border-radius:12px;padding:12px;margin:8px 0;">
                        <div style="font-weight:700;font-size:0.85rem;margin-bottom:10px;color:var(--text2);">–û–ü–†–û–°</div>
                        <input type="text" class="comment-input" id="pollOpt1" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1" style="border:1px solid var(--border);border-radius:8px;padding:8px 12px;width:100%;margin-bottom:6px;background:var(--bg3);color:var(--text);">
                        <input type="text" class="comment-input" id="pollOpt2" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2" style="border:1px solid var(--border);border-radius:8px;padding:8px 12px;width:100%;margin-bottom:6px;background:var(--bg3);color:var(--text);">
                        <input type="text" class="comment-input" id="pollOpt3" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 3 (–Ω–µ–æ–±—è–∑.)" style="border:1px solid var(--border);border-radius:8px;padding:8px 12px;width:100%;margin-bottom:6px;background:var(--bg3);color:var(--text);">
                        <input type="text" class="comment-input" id="pollOpt4" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 4 (–Ω–µ–æ–±—è–∑.)" style="border:1px solid var(--border);border-radius:8px;padding:8px 12px;width:100%;background:var(--bg3);color:var(--text);">
                    </div>
                    <div class="composer-divider"></div>
                    <div class="composer-bottom">
                        <div class="composer-tools">
                            <!-- Photo upload -->
                            <input type="file" id="photoFileInput" accept="image/*" multiple style="display:none;" onchange="handlePhotoSelect(event)">
                            <button class="composer-tool-btn" title="–§–æ—Ç–æ" onclick="document.getElementById('photoFileInput').click()">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21 15 16 10 5 21"/>
                                </svg>
                            </button>
                            <!-- Poll -->
                            <button class="composer-tool-btn" title="–û–ø—Ä–æ—Å" id="pollToggleBtn" onclick="togglePoll()">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                </svg>
                            </button>
                            <!-- Voice -->
                            <button class="composer-tool-btn" title="–ì–æ–ª–æ—Å–æ–≤–æ–π –ø–æ—Å—Ç" id="voicePostBtn" onclick="toggleVoicePost()" style="font-size:1rem;">üéôÔ∏è</button>
                        </div>
                        <div class="composer-right-tools">
                            <span class="char-counter" id="charCounter">500</span>
                            <button class="post-btn" id="postBtn" onclick="publishPost()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AUTH WALL (shown if not logged in) -->
            <div class="auth-wall" id="authWall" style="display:none;">
                <div class="auth-wall-title">–í–æ–π–¥–∏, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å –ø–æ—Å—Ç—ã</div>
                <div class="auth-wall-sub">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Å—è —á–µ—Ä–µ–∑ Google –∏ —Å—Ç–∞–Ω—å —á–∞—Å—Ç—å—é –ø–æ–∑–æ—Ä–∞</div>
                <button class="google-btn" onclick="signIn()">
                    <svg width="18" height="18" viewBox="0 0 18 18">
                        <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/>
                        <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                        <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707s.102-1.167.282-1.707V4.961H.957C.347 6.175 0 7.55 0 9s.348 2.825.957 4.039l3.007-2.332z"/>
                        <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                    </svg>
                    –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                </button>
            </div>

            <!-- POSTS -->
            <div id="postsContainer">
                <div class="feed-loading"><div class="spinner-small"></div>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã...</div>
            </div>
        </div>

        <!-- PROFILE VIEW -->
        <div id="profileView" style="display:none;">
            <div class="profile-banner" id="profileBanner">
                <button class="profile-banner-edit" id="profileBannerEditBtn" style="display:none;" onclick="openModal('editProfileModal')">üñä</button>
            </div>
            <div class="profile-header">
                <div class="profile-avatar-row">
                    <div class="profile-avatar" id="profileAvatarEl">ü§°</div>
                    <div>
                        <button class="profile-edit-btn" id="profileEditBtn" style="display:none;" onclick="openModal('editProfileModal')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="follow-btn" id="profileFollowBtn" style="display:none;" onclick="toggleFollow()">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                    </div>
                </div>
                <div class="profile-name" id="profileName">–ò–º—è</div>
                <div class="profile-handle" id="profileHandle">@handle</div>
                <div class="profile-bio" id="profileBio" style="display:none;"></div>
                <div class="profile-meta">
                    <span>üìÖ <span id="profileJoined">‚Äî</span></span>
                </div>
                <div class="profile-stats">
                    <span style="cursor:pointer;" onclick="openFollowList('following')"><span class="profile-stat-val" id="profileFollowing">0</span> <span class="profile-stat-label">–ø–æ–¥–ø–∏—Å–æ–∫</span></span>
                    <span style="cursor:pointer;" onclick="openFollowList('followers')"><span class="profile-stat-val" id="profileFollowers">0</span> <span class="profile-stat-label">–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</span></span>
                </div>
            </div>
            <div class="profile-tabs">
                <button class="profile-tab active" id="ptabPosts" onclick="switchProfileTab('posts')">–ü–æ—Å—Ç—ã</button>
                <button class="profile-tab" id="ptabWall" onclick="switchProfileTab('wall')">–°—Ç–µ–Ω–∞</button>
                <button class="profile-tab" id="ptabLikes" onclick="switchProfileTab('likes')">–õ–∞–π–∫–∏</button>
            </div>
            <div id="profilePostsContainer">
                <div class="feed-loading"><div class="spinner-small"></div>–ó–∞–≥—Ä—É–∂–∞–µ–º...</div>
            </div>
        </div>

        <!-- CHAT VIEW -->
        <div id="chatView" style="display:none;">
            <div class="feed-header">
                <div class="feed-header-title">üí¨ –û–±—â–∏–π —á–∞—Ç</div>
            </div>
            <div id="socialChatMessages" style="
                height: calc(100vh - 180px);
                overflow-y: auto;
                padding: 12px 16px;
                display: flex;
                flex-direction: column;
                gap: 6px;
            ">
                <div style="text-align:center;color:var(--text2);padding:20px;font-size:0.85rem;">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
            </div>
            <div style="
                border-top: 1px solid var(--border);
                padding: 12px 16px;
                display: flex;
                gap: 10px;
                align-items: flex-end;
                background: rgba(15,15,15,0.9);
                backdrop-filter: blur(12px);
                position: sticky;
                bottom: 0;
                flex-direction: column;
            " id="socialChatInputArea">
                <!-- Photo preview row -->
                <div id="chatPhotoPreviewRow" style="display:none;width:100%;gap:8px;flex-wrap:wrap;"></div>
                <!-- Input row -->
                <div style="display:flex;gap:10px;align-items:flex-end;width:100%;">
                <img src="img/ico2.png" id="socialChatAvatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;">
                <!-- Photo attach button -->
                <input type="file" id="chatPhotoInput" accept="image/*" style="display:none;" onchange="handleChatPhotoSelect(event)">
                <button onclick="document.getElementById('chatPhotoInput').click()" title="–§–æ—Ç–æ" class="composer-tool-btn" style="flex-shrink:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/>
                        <polyline points="21 15 16 10 5 21"/>
                    </svg>
                </button>
                <button id="voiceChatBtn" onclick="toggleVoiceChat()" title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" class="composer-tool-btn" style="flex-shrink:0;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                </button>
                <textarea id="socialChatInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="
                    flex:1;
                    background: var(--bg3);
                    border: 1px solid var(--border);
                    border-radius: 20px;
                    color: var(--text);
                    font-family: Inter, sans-serif;
                    font-size: 0.92rem;
                    padding: 10px 16px;
                    resize: none;
                    min-height: 42px;
                    max-height: 120px;
                    outline: none;
                    line-height: 1.4;
                    transition: border-color 0.15s;
                " oninput="autoResizeSocialChat(this)" onkeydown="handleSocialChatKey(event)"></textarea>
                <button onclick="sendSocialChatMessage()" style="
                    background: var(--accent);
                    color: #fff;
                    border: none;
                    border-radius: 50%;
                    width: 42px;
                    height: 42px;
                    font-size: 1.1rem;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                    transition: background 0.15s;
                " title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
                </div>
            </div>
        </div>

        <!-- SEARCH VIEW -->
        <div id="searchView" style="display:none;">
            <div class="feed-header">
                <div class="feed-header-title">–ü–æ–∏—Å–∫</div>
            </div>
            <div style="padding:16px;">
                <div class="search-box" style="background:var(--bg3);margin-bottom:0;">
                    <span class="search-box-icon">üîç</span>
                    <input type="text" class="search-input" id="searchQueryInput" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="doSearch(this.value)">
                </div>
            </div>
            <div id="searchResults">
                <div class="empty-state">
                    <div class="empty-state-icon">üîç</div>
                    <div class="empty-state-title">–ù–∞–π–¥–∏ –∫–æ–≥–æ-–Ω–∏–±—É–¥—å</div>
                    <div class="empty-state-sub">–í–≤–æ–¥–∏ –∏–º—è –∏–ª–∏ @username</div>
                </div>
            </div>
        </div>

        <!-- ADMIN VIEW -->
        <div id="adminView" style="display:none;">
            <div class="feed-header">
                <div class="feed-header-title">üõ°Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</div>
                <div class="admin-tabs">
                    <button class="admin-tab active" id="atab-stats" onclick="switchAdminTab('stats')">üìä –°—Ç–∞—Ç–∞</button>
                    <button class="admin-tab" id="atab-users" onclick="switchAdminTab('users')">üë• –Æ–∑–µ—Ä—ã</button>
                    <button class="admin-tab" id="atab-posts" onclick="switchAdminTab('posts')">üìù –ü–æ—Å—Ç—ã</button>
                    <button class="admin-tab" id="atab-chat" onclick="switchAdminTab('chat')">üí¨ –ß–∞—Ç</button>
                </div>
            </div>
            <div id="adminContent">
                <div class="feed-loading"><div class="spinner-small"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

    </main>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
        <div class="search-box">
            <span class="search-box-icon">üîç</span>
            <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫..." oninput="doSearch(this.value)">
        </div>
        <div class="widget">
            <div class="widget-title">–ö–æ–≥–æ —á–∏—Ç–∞—Ç—å</div>
            <div id="suggestedUsers">
                <div class="feed-loading"><div class="spinner-small"></div></div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase compat (—Ç–µ –∂–µ –≤–µ—Ä—Å–∏–∏ —á—Ç–æ –∏ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∞–π—Ç–µ) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

<script>
// ===== FIREBASE INIT =====
const firebaseConfig = {
    apiKey: 'AIzaSyC-bSkpW3DiIo5aTx0bfI7nqnvU2EIl2c4',
    authDomain: 'dima-chat-ae605.firebaseapp.com',
    databaseURL: 'https://dima-chat-ae605-default-rtdb.europe-west1.firebasedatabase.app',
    projectId: 'dima-chat-ae605',
    storageBucket: 'dima-chat-ae605.firebasestorage.app',
    messagingSenderId: '353476225291',
    appId: '1:353476225291:web:b34851858e6565be22da0e',
}

firebase.initializeApp(firebaseConfig)
const auth = firebase.auth()
const db = firebase.database()
const storage = firebase.storage()
const provider = new firebase.auth.GoogleAuthProvider()

const ADMIN_EMAIL = 'klosa148@gmail.com' // ‚Üê –≤–∞—à–∞ –ø–æ—á—Ç–∞

// ===== STATE =====
let currentUser = null
let currentUserData = null
let viewingUid = null
let currentFeedTab = 'forYou'
const viewedPostsSet = new Set()  // track viewed posts this session
let currentProfileTab = 'posts'
let postsUnsubscribe = null

// ===== AUTH =====
auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user
        const snap = await db.ref(`social_users/${user.uid}`).once('value')
        if (!snap.exists()) {
            // New user ‚Äî show username setup
            document.getElementById('usernameSetup').classList.add('open')
        } else {
            currentUserData = snap.val()
            // Sync Google avatar if user has photoURL and it differs
            if (user.photoURL && currentUserData.avatar !== user.photoURL) {
                await db.ref(`social_users/${user.uid}`).update({ avatar: user.photoURL })
                currentUserData.avatar = user.photoURL
            }
            onUserReady()
        }
    } else {
        currentUser = null
        currentUserData = null
        onUserReady()
    }
})

function onUserReady() {
    updateSidebar()
    updateComposer()
    loadFeed()
    loadSuggestedUsers()
}

function updateSidebar() {
    if (currentUserData) {
        document.getElementById('sidebarName').textContent = currentUserData.name || currentUserData.username
        document.getElementById('sidebarHandle').textContent = '@' + currentUserData.username
        if (currentUserData.avatar) document.getElementById('sidebarAvatar').src = currentUserData.avatar
    } else {
        document.getElementById('sidebarName').textContent = '–ì–æ—Å—Ç—å'
        document.getElementById('sidebarHandle').textContent = '@–≥–æ—Å—Ç—å'
    }
}

function updateComposer() {
    if (currentUser && currentUserData) {
        document.getElementById('composer').style.display = 'flex'
        document.getElementById('authWall').style.display = 'none'
        if (currentUserData.avatar) document.getElementById('composerAvatar').src = currentUserData.avatar
    } else {
        document.getElementById('composer').style.display = 'none'
        document.getElementById('authWall').style.display = 'block'
    }
}

function signIn() {
    auth.signInWithPopup(provider).catch(e => showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message))
}

// ===== USERNAME SETUP =====
async function submitUsername() {
    const input = document.getElementById('usernameInput')
    const error = document.getElementById('usernameError')
    const btn = document.getElementById('usernameSubmit')
    const val = input.value.trim().toLowerCase()

    if (!/^[a-z0-9_]{3,20}$/.test(val)) {
        error.textContent = '–û—Ç 3 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤, —Ç–æ–ª—å–∫–æ a-z, 0-9, _'
        return
    }
    btn.disabled = true
    error.textContent = ''

    // Check uniqueness
    const check = await db.ref('social_usernames/' + val).once('value')
    if (check.exists()) {
        error.textContent = '–≠—Ç–æ—Ç —é–∑–µ—Ä–Ω–µ–π–º —É–∂–µ –∑–∞–Ω—è—Ç'
        btn.disabled = false
        return
    }

    const userData = {
        username: val,
        name: currentUser.displayName || val,
        avatar: currentUser.photoURL || '',
        bio: '',
        createdAt: Date.now(),
        followers: 0,
        following: 0,
    }

    await db.ref(`social_users/${currentUser.uid}`).set(userData)
    await db.ref(`social_usernames/${val}`).set(currentUser.uid)

    currentUserData = userData
    document.getElementById('usernameSetup').classList.remove('open')
    onUserReady()
}

// ===== NAVIGATION =====
function showFeed() {
    setNavActive('navFeed')
    document.getElementById('feedView').style.display = 'block'
    document.getElementById('profileView').style.display = 'none'
    document.getElementById('searchView').style.display = 'none'
    document.getElementById('chatView').style.display = 'none'
    document.getElementById('adminView').style.display = 'none'
    loadFeed()
}

function showSearch() {
    setNavActive('navSearch')
    document.getElementById('feedView').style.display = 'none'
    document.getElementById('profileView').style.display = 'none'
    document.getElementById('chatView').style.display = 'none'
    document.getElementById('searchView').style.display = 'block'
    document.getElementById('adminView').style.display = 'none'
}

function showMyProfile() {
    if (!currentUser) { showToast('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å'); return; }
    showProfile(currentUser.uid)
    setNavActive('navProfile')
}

function showProfile(uid) {
    setNavActive(uid === currentUser?.uid ? 'navProfile' : null)
    document.getElementById('feedView').style.display = 'none'
    document.getElementById('searchView').style.display = 'none'
    document.getElementById('chatView').style.display = 'none'
    document.getElementById('adminView').style.display = 'none'
    document.getElementById('profileView').style.display = 'block'
    viewingUid = uid
    loadProfile(uid)
    switchProfileTab('posts')
    watchFollowCounts(uid)
}

function setNavActive(id) {
    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'))
    if (id) document.getElementById(id)?.classList.add('active')
}

// ===== FEED TABS =====
function switchFeedTab(tab) {
    currentFeedTab = tab
    document.getElementById('tabForYou').classList.toggle('active', tab === 'forYou')
    document.getElementById('tabFollowing').classList.toggle('active', tab === 'following')
    loadFeed()
}

// ===== FEED =====
let feedRef = null  // store ref to properly detach listener

function loadFeed() {
    const container = document.getElementById('postsContainer')
    container.innerHTML = '<div class="feed-loading"><div class="spinner-small"></div>–ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å—Ç—ã...</div>'

    // Properly detach previous listener using the same ref object
    if (feedRef) {
        feedRef.off('value')
        feedRef = null
    }

    // No limitToLast, no orderByChild ‚Äî read all posts, sort client-side
    feedRef = db.ref('social_posts')

    feedRef.on('value', async snap => {
        const allPosts = []
        snap.forEach(child => {
            const val = child.val()
            if (val) allPosts.push({ id: child.key, ...val })
        })
        allPosts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))

        console.log('[Feed] –ø–æ—Å—Ç–æ–≤ –∏–∑ Firebase:', allPosts.length)

        if (currentFeedTab === 'following' && currentUser) {
            const followSnap = await db.ref(`social_follows/${currentUser.uid}`).once('value')
            const followingUids = {}
            followSnap.forEach(c => { followingUids[c.key] = true })
            const filtered = allPosts.filter(p => followingUids[p.authorUid] || p.authorUid === currentUser.uid)
            renderPosts(filtered, container)
        } else {
            renderPosts(allPosts, container)
        }
    }, err => {
        console.error('[Feed] –û—à–∏–±–∫–∞ Firebase:', err.code, err.message)
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><div class="empty-state-title">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</div></div>`
    })
}

function renderPosts(posts, container) {
    if (!posts.length) {
        container.innerHTML = `<div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div class="empty-state-title">–ü–æ–∫–∞ —Ç–∏—Ö–æ</div>
            <div class="empty-state-sub">–ë—É–¥—å –ø–µ—Ä–≤—ã–º –∫—Ç–æ –Ω–∞–ø–∏—à–µ—Ç!</div>
        </div>`
        return
    }
    container.innerHTML = posts.map(p => buildPostCard(p)).join('')
}

function buildPostCard(post) {
    const isLiked = currentUser && post.likedBy && post.likedBy[currentUser.uid]
    const timeStr = formatTime(post.createdAt)
    const avatarHtml = post.authorAvatar
        ? `<img src="${post.authorAvatar}" class="post-avatar" onclick="showProfile('${post.authorUid}')" onerror="this.style.display='none'">`
        : `<div class="post-avatar" onclick="showProfile('${post.authorUid}')" style="display:flex;align-items:center;justify-content:center;font-size:1.3rem;">ü§°</div>`

    // Photos
    let photosHtml = ''
    if (post.photos && post.photos.length) {
        const cols = post.photos.length === 1 ? '1fr' : (post.photos.length === 2 ? '1fr 1fr' : (post.photos.length === 3 ? '1fr 1fr 1fr' : '1fr 1fr'))
        const postKey = 'pk_' + (post.id || (post.createdAt + '_' + post.authorUid))
        window._postPhotosRegistry = window._postPhotosRegistry || {}
        window._postPhotosRegistry[postKey] = post.photos
        photosHtml = `<div style="display:grid;grid-template-columns:${cols};gap:4px;border-radius:12px;overflow:hidden;margin-top:8px;">`
        post.photos.forEach((src, idx) => {
            photosHtml += `<img src="${src}" style="width:100%;${post.photos.length===1?'max-height:480px;':'aspect-ratio:1;'}object-fit:${post.photos.length===1?'contain':'cover'};background:#111;cursor:zoom-in;border-radius:4px;" onclick="event.stopPropagation();openLightboxByKey(${idx},'${postKey}')">`
        })
        photosHtml += '</div>'
    }

    // Poll
    let pollHtml = ''
    if (post.poll && post.poll.options) {
        const totalVotes = post.poll.options.reduce((s, _, i) => s + (post.poll.votes?.[i] || 0), 0)
        const hasVoted = currentUser && post.poll.userVotes && post.poll.userVotes[currentUser.uid] !== undefined
        pollHtml = `<div style="border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px;">` +
            post.poll.options.map((opt, i) => {
                const count = post.poll.votes?.[i] || 0
                const pct = totalVotes ? Math.round(count/totalVotes*100) : 0
                return hasVoted
                    ? `<div style="margin-bottom:6px;"><div style="display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:3px;">${esc(opt)}<span>${pct}%</span></div><div style="height:6px;background:var(--bg4);border-radius:3px;"><div style="width:${pct}%;height:100%;background:var(--accent);border-radius:3px;"></div></div></div>`
                    : `<button onclick="event.stopPropagation();votePoll('${post.id}',${i})" style="width:100%;padding:8px 14px;margin-bottom:6px;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:50px;cursor:pointer;font-family:Inter,sans-serif;font-size:0.9rem;text-align:left;">${esc(opt)}</button>`
            }).join('') +
            `<div style="font-size:0.78rem;color:var(--text2);margin-top:4px;">${totalVotes} –≥–æ–ª–æ—Å–æ–≤</div></div>`
    }

    return `<div class="post-card" onclick="openPost('${post.id}')">
        ${avatarHtml}
        <div class="post-right">
            <div class="post-header">
                <span class="post-name" onclick="event.stopPropagation();showProfile('${post.authorUid}')">${esc(post.authorName)}</span>
                <span class="post-handle">@${esc(post.authorUsername)}</span>
                <span class="post-dot">¬∑</span>
                <span class="post-time">${timeStr}</span>
                <button class="post-more" onclick="event.stopPropagation()">¬∑¬∑¬∑</button>
            </div>
            <div class="post-text">${esc(post.text)}</div>
            ${photosHtml}
            ${pollHtml}
            ${post.voice ? buildVoicePlayerWidget(post.voice, post.voiceDuration||0) : ''}
            <div class="post-actions">
                <button class="action-btn like ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation();toggleLike('${post.id}')">
                    <span class="action-icon">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
                    <span>${post.likes || 0}</span>
                </button>
                <button class="action-btn comment" onclick="event.stopPropagation();openPost('${post.id}')">
                    <span class="action-icon">üí¨</span>
                    <span>${post.commentCount || 0}</span>
                </button>
                <button class="action-btn views">
                    <span class="action-icon">üëÅ</span>
                    <span>${post.views || 0}</span>
                </button>
            </div>
        </div>
    </div>`
}

// ===== PUBLISH POST =====
function updateCharCounter() {
    const ta = document.getElementById('postText')
    const remaining = 500 - ta.value.length
    const el = document.getElementById('charCounter')
    el.textContent = remaining
    el.className = 'char-counter' + (remaining < 50 ? (remaining < 20 ? ' danger' : ' warn') : '')
    document.getElementById('postBtn').disabled = ta.value.trim().length === 0
}

// ===== PHOTO UPLOAD =====
let selectedPhotos = [] // base64 array

function handlePhotoSelect(event) {
    const files = Array.from(event.target.files)
    if (!files.length) return
    const remaining = 4 - selectedPhotos.length
    if (remaining <= 0) { showToast('–ú–∞–∫—Å–∏–º—É–º 4 —Ñ–æ—Ç–æ'); return; }
    const toLoad = files.slice(0, remaining)
    toLoad.forEach(file => {
        const reader = new FileReader()
        reader.onload = e => {
            selectedPhotos.push(e.target.result)
            renderPhotoPreviews()
        }
        reader.readAsDataURL(file)
    })
    event.target.value = ''
}

function renderPhotoPreviews() {
    const row = document.getElementById('photoPreviewRow')
    if (!selectedPhotos.length) { row.style.display = 'none'; row.innerHTML = ''; return; }
    row.style.display = 'flex'
    row.innerHTML = selectedPhotos.map((src, i) => `
        <div style="position:relative;display:inline-block;">
            <img src="${src}" style="width:80px;height:80px;object-fit:cover;border-radius:10px;border:1px solid var(--border);">
            <button onclick="removePhoto(${i})" style="position:absolute;top:-6px;right:-6px;background:var(--bg);border:1px solid var(--border);border-radius:50%;width:22px;height:22px;font-size:12px;cursor:pointer;color:var(--text);display:flex;align-items:center;justify-content:center;">‚úï</button>
        </div>
    `).join('')
}

function removePhoto(idx) {
    selectedPhotos.splice(idx, 1)
    renderPhotoPreviews()
}

// ===== POLL TOGGLE =====
let pollActive = false
function togglePoll() {
    pollActive = !pollActive
    const section = document.getElementById('pollSection')
    const btn = document.getElementById('pollToggleBtn')
    section.style.display = pollActive ? 'block' : 'none'
    btn.style.borderColor = pollActive ? 'var(--text)' : 'var(--border)'
    btn.style.background = pollActive ? 'var(--bg4)' : 'var(--bg3)'
}

async function publishPost() {
    if (!currentUser || !currentUserData) { showToast('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!'); return; }
    const text = document.getElementById('postText').value.trim()
    if (!text && !selectedPhotos.length && !window._voicePostBlob) return

    const btn = document.getElementById('postBtn')
    btn.disabled = true
    btn.textContent = '–ü—É–±–ª–∏–∫—É–µ–º...'

    // Build poll data if active
    let pollData = null
    if (pollActive) {
        const opts = ['pollOpt1','pollOpt2','pollOpt3','pollOpt4']
            .map(id => document.getElementById(id).value.trim())
            .filter(Boolean)
        if (opts.length >= 2) {
            pollData = { options: opts, votes: {} }
        }
    }

    try {
        const postObj = {
            text: text || '',
            authorUid: currentUser.uid,
            authorName: currentUserData.name || currentUserData.username,
            authorUsername: currentUserData.username,
            authorAvatar: currentUserData.avatar || '',
            createdAt: Date.now(),
            likes: 0,
            commentCount: 0,
            views: 0,
        }
        if (selectedPhotos.length) postObj.photos = selectedPhotos
        if (pollData) postObj.poll = pollData

        // Upload voice if attached (base64 in DB)
        if (window._voicePostBlob) {
            btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ–ª–æ—Å–∞...'
            const base64Voice = await new Promise((resolve, reject) => {
                const reader = new FileReader()
                reader.onload = () => resolve(reader.result)
                reader.onerror = reject
                reader.readAsDataURL(window._voicePostBlob)
            })
            postObj.voice = base64Voice
            postObj.voiceDuration = window._voicePostDuration || 0
            window._voicePostBlob = null
            window._voicePostDuration = 0
        }

        await db.ref('social_posts').push(postObj)
        document.getElementById('postText').value = ''
        selectedPhotos = []
        renderPhotoPreviews()
        if (pollActive) togglePoll()
        ;['pollOpt1','pollOpt2','pollOpt3','pollOpt4'].forEach(id => { document.getElementById(id).value = '' })
        updateCharCounter()
        cancelVoicePost()
        showToast('‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!')

        // Reload profile posts if profile is open
        if (viewingUid && document.getElementById('profileView').style.display !== 'none' && currentProfileTab === 'posts') {
            loadProfilePosts(viewingUid)
        }
    } catch (e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message)
    }
    btn.disabled = false
    btn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å'
}

// ===== POLL VOTE =====
async function votePoll(postId, optionIndex) {
    if (!currentUser) { showToast('–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –≥–æ–ª–æ—Å–æ–≤–∞—Ç—å'); return; }
    const ref = db.ref(`social_posts/${postId}`)
    const snap = await ref.once('value')
    const post = snap.val()
    if (!post || !post.poll) return
    if (post.poll.userVotes && post.poll.userVotes[currentUser.uid] !== undefined) {
        showToast('–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏'); return;
    }
    await ref.transaction(p => {
        if (!p || !p.poll) return p
        if (!p.poll.votes) p.poll.votes = {}
        if (!p.poll.userVotes) p.poll.userVotes = {}
        p.poll.votes[optionIndex] = (p.poll.votes[optionIndex] || 0) + 1
        p.poll.userVotes[currentUser.uid] = optionIndex
        return p
    })
    showToast('‚úÖ –ì–æ–ª–æ—Å –∑–∞—Å—á–∏—Ç–∞–Ω!')
}

// ===== LIKES =====
async function toggleLike(postId) {
    if (!currentUser) { showToast('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ª–∞–π–∫–∞—Ç—å'); return; }
    const ref = db.ref(`social_posts/${postId}`)
    const snap = await ref.once('value')
    const post = snap.val()
    if (!post) return

    const liked = post.likedBy && post.likedBy[currentUser.uid]
    const updates = {
        likes: (post.likes || 0) + (liked ? -1 : 1),
        [`likedBy/${currentUser.uid}`]: liked ? null : true
    }
    await ref.update(updates)
}

// ===== POST DETAIL =====
async function openPost(postId) {
    const snap = await db.ref(`social_posts/${postId}`).once('value')
    const post = snap.val()
    if (!post) return

    // Increment views only once per session
    if (!viewedPostsSet.has(postId)) {
        viewedPostsSet.add(postId)
        db.ref(`social_posts/${postId}`).transaction(p => {
            if (p) p.views = (p.views || 0) + 1
            return p
        })
    }

    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª –ü–ï–†–í–´–ú, —á—Ç–æ–±—ã DOM –±—ã–ª –≥–æ—Ç–æ–≤
    openModal('postDetailModal')

    const body = document.getElementById('postDetailBody')
    const isLiked = currentUser && post.likedBy && post.likedBy[currentUser.uid]
    const avatarHtml = post.authorAvatar
        ? `<img src="${post.authorAvatar}" style="width:42px;height:42px;border-radius:50%;object-fit:cover;">`
        : `<div style="font-size:2rem;">ü§°</div>`

    body.innerHTML = `
        <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center;">
            ${avatarHtml}
            <div>
                <div style="font-weight:700;">${esc(post.authorName)}</div>
                <div style="color:var(--text2);font-size:0.85rem;">@${esc(post.authorUsername)}</div>
            </div>
        </div>
        <div style="font-size:1.1rem;line-height:1.7;margin-bottom:16px;white-space:pre-wrap;">${esc(post.text)}</div>
        <div style="color:var(--text2);font-size:0.85rem;margin-bottom:12px;">${new Date(post.createdAt).toLocaleString('ru')}</div>
        <div style="display:flex;gap:6px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);padding:8px 0;margin-bottom:12px;">
            <button class="action-btn like ${isLiked?'liked':''}" onclick="toggleLike('${postId}')">
                <span class="action-icon">${isLiked?'‚ù§Ô∏è':'ü§ç'}</span> ${post.likes||0}
            </button>
            <button class="action-btn comment">
                <span class="action-icon">üí¨</span> ${post.commentCount||0}
            </button>
        </div>
        <div id="postComments"><div class="feed-loading"><div class="spinner-small"></div></div></div>
        ${currentUser ? `<div class="comment-input-row">
            <img src="${currentUserData?.avatar||'img/ico2.png'}" class="comment-avatar" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">
            <textarea class="comment-input" id="commentInput" placeholder="–ù–∞–ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            <button class="comment-send-btn" onclick="sendComment('${postId}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>` : '<div style="color:var(--text2);text-align:center;padding:12px;">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å</div>'}
    `

    // –ó–∞–ø—É—Å–∫–∞–µ–º listener –ü–û–°–õ–ï —Ç–æ–≥–æ –∫–∞–∫ div#postComments —É–∂–µ –≤ DOM
    loadComments(postId)
}

let commentsListener = null
let commentsListenerPostId = null

async function loadComments(postId) {
    // Detach previous listener
    if (commentsListener && commentsListenerPostId) {
        db.ref(`social_comments/${commentsListenerPostId}`).off('value', commentsListener)
    }

    const container = document.getElementById('postComments')
    if (!container) return

    commentsListenerPostId = postId
    console.log('[Comments] –ß–∏—Ç–∞–µ–º –ø—É—Ç—å:', `social_comments/${postId}`)
    commentsListener = db.ref(`social_comments/${postId}`).on('value', snap => {
        const container2 = document.getElementById('postComments')
        if (!container2) { console.warn('[Comments] –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM'); return }
        const comments = []
        snap.forEach(c => {
            const val = c.val()
            console.log('[Comments] —É–∑–µ–ª:', c.key, val)
            comments.push({ id: c.key, ...val })
        })
        comments.sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0))
        console.log('[Comments] –ü–æ–ª—É—á–µ–Ω–æ –∏–∑ Firebase:', comments.length, comments)

        if (!comments.length) {
            container2.innerHTML = '<div style="color:var(--text2);text-align:center;padding:20px;font-size:0.9rem;">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –Ω–µ—Ç ‚Äî –Ω–∞–ø–∏—à–∏ –ø–µ—Ä–≤—ã–º!</div>'
            return
        }
        container2.innerHTML = comments.map(c => `
            <div class="comment-card">
                <div class="comment-avatar">${c.authorAvatar ? `<img src="${c.authorAvatar}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">` : 'ü§°'}</div>
                <div class="comment-body">
                    <span class="comment-name">${esc(c.authorName || c.authorUsername || '–ê–Ω–æ–Ω–∏–º')}</span>
                    <span class="comment-handle" style="margin-left:6px;">@${esc(c.authorUsername || '?')} ¬∑ ${formatTime(c.createdAt)}</span>
                    <div class="comment-text">${esc(c.text || '')}</div>
                </div>
            </div>
        `).join('')
        console.log('[Comments] –û—Ç—Ä–∏—Å–æ–≤–∞–Ω–æ:', comments.length, comments)
    })
}

async function sendComment(postId) {
    if (!currentUser || !currentUserData) return
    const input = document.getElementById('commentInput')
    const text = input.value.trim()
    if (!text) return
    input.value = ''

    try {
        await db.ref(`social_comments/${postId}`).push({
            text,
            authorUid: currentUser.uid,
            authorName: currentUserData.name || currentUserData.username,
            authorUsername: currentUserData.username,
            authorAvatar: currentUserData.avatar || '',
            createdAt: Date.now(),
        })
        // Increment comment count
        db.ref(`social_posts/${postId}`).transaction(p => {
            if (p) p.commentCount = (p.commentCount || 0) + 1
            return p
        })
        // –ù–ï –≤—ã–∑—ã–≤–∞–µ–º loadComments ‚Äî real-time listener —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç
    } catch(e) {
        showToast('–û—à–∏–±–∫–∞: ' + e.message)
        document.getElementById('commentInput').value = text // –≤–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
    }
}

// ===== PROFILE =====
async function loadProfile(uid) {
    const snap = await db.ref(`social_users/${uid}`).once('value')
    const user = snap.val()
    if (!user) return

    const isMe = currentUser && currentUser.uid === uid

    document.getElementById('profileName').textContent = user.name || user.username
    document.getElementById('profileHandle').textContent = '@' + user.username

    // –ß–∏—Ç–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å–æ–∫/–ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –∏–∑ social_follows
    const [followingSnap, allFollowsSnap] = await Promise.all([
        db.ref(`social_follows/${uid}`).once('value'),
        db.ref('social_follows').once('value')
    ])
    const realFollowing = followingSnap.numChildren()
    let realFollowers = 0
    allFollowsSnap.forEach(node => { if (node.child(uid).exists()) realFollowers++ })
    document.getElementById('profileFollowing').textContent = realFollowing
    document.getElementById('profileFollowers').textContent = realFollowers

    document.getElementById('profileJoined').textContent = new Date(user.createdAt || Date.now()).toLocaleDateString('ru', { month: 'long', year: 'numeric' })

    const bioEl = document.getElementById('profileBio')
    if (user.bio) { bioEl.textContent = user.bio; bioEl.style.display = 'block' }
    else { bioEl.style.display = 'none' }

    const avatarEl = document.getElementById('profileAvatarEl')
    if (user.avatar) {
        avatarEl.innerHTML = `<img src="${user.avatar}" style="width:88px;height:88px;border-radius:50%;object-fit:cover;border:4px solid var(--bg);">`
    } else {
        avatarEl.textContent = 'ü§°'
    }

    document.getElementById('profileEditBtn').style.display = isMe ? 'block' : 'none'
    document.getElementById('profileBannerEditBtn').style.display = isMe ? 'flex' : 'none'

    if (!isMe && currentUser) {
        const followBtn = document.getElementById('profileFollowBtn')
        followBtn.style.display = 'block'
        const followSnap = await db.ref(`social_follows/${currentUser.uid}/${uid}`).once('value')
        if (followSnap.exists()) {
            followBtn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è'
            followBtn.className = 'follow-btn following'
        } else {
            followBtn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'
            followBtn.className = 'follow-btn'
        }
        followBtn.dataset.targetUid = uid
    } else {
        document.getElementById('profileFollowBtn').style.display = 'none'
    }

    // Prefill edit modal
    document.getElementById('editName').value = user.name || ''
    document.getElementById('editBio').value = user.bio || ''
    document.getElementById('editAvatar').value = user.avatar || ''
}

function switchProfileTab(tab) {
    currentProfileTab = tab
    document.querySelectorAll('.profile-tab').forEach(b => b.classList.remove('active'))
    document.getElementById(`ptab${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.add('active')

    if (tab === 'posts') loadProfilePosts(viewingUid)
    else if (tab === 'wall') loadWall(viewingUid)
    else if (tab === 'likes') loadLikedPosts(viewingUid)
}

async function loadProfilePosts(uid) {
    const container = document.getElementById('profilePostsContainer')
    container.innerHTML = '<div class="feed-loading"><div class="spinner-small"></div></div>'
    // Don't use orderByChild (requires Firebase index) ‚Äî fetch all and filter client-side
    const snap = await db.ref('social_posts').once('value')
    const posts = []
    snap.forEach(c => {
        const val = c.val()
        if (val && val.authorUid === uid) posts.push({ id: c.key, ...val })
    })
    posts.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
    console.log('[Profile] –ø–æ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', uid, ':', posts.length)
    if (!posts.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-title">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤</div></div>'
    } else {
        container.innerHTML = posts.map(p => buildPostCard(p)).join('')
    }
}

async function loadWall(uid) {
    const container = document.getElementById('profilePostsContainer')
    container.innerHTML = '<div class="feed-loading"><div class="spinner-small"></div></div>'
    const snap = await db.ref(`social_walls/${uid}`).orderByChild('createdAt').once('value')
    const comments = []
    snap.forEach(c => comments.unshift({ id: c.key, ...c.val() }))

    let html = ''
    if (currentUser && currentUserData) {
        html += `<div class="composer" style="border-bottom:1px solid var(--border);">
            <div class="comment-avatar" style="width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--bg4);font-size:1.3rem;">${currentUserData.avatar ? `<img src="${currentUserData.avatar}" style="width:42px;height:42px;border-radius:50%;object-fit:cover;">` : 'ü§°'}</div>
            <div style="flex:1;">
                <textarea class="composer-textarea" id="wallInput" placeholder="–ù–∞–ø–∏—à–∏ –Ω–∞ —Å—Ç–µ–Ω–µ..." style="min-height:50px;font-size:0.95rem;"></textarea>
                <div style="text-align:right;margin-top:6px;">
                    <button class="comment-send-btn" onclick="sendWallPost('${uid}')">–ù–∞–ø–∏—Å–∞—Ç—å</button>
                </div>
            </div>
        </div>`
    }

    if (!comments.length) {
        html += '<div class="empty-state"><div class="empty-state-icon">üí¨</div><div class="empty-state-title">–°—Ç–µ–Ω–∞ –ø—É—Å—Ç–∞</div><div class="empty-state-sub">–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å!</div></div>'
    } else {
        html += comments.map(c => `
            <div class="comment-card" style="padding:14px 16px;border-bottom:1px solid var(--border);">
                <div style="font-size:1.8rem;width:42px;text-align:center;">${c.authorAvatar ? `<img src="${c.authorAvatar}" style="width:38px;height:38px;border-radius:50%;object-fit:cover;">` : 'ü§°'}</div>
                <div style="flex:1;">
                    <span style="font-weight:700;font-size:0.9rem;">${esc(c.authorName)}</span>
                    <span style="color:var(--text2);font-size:0.8rem;margin-left:6px;">@${esc(c.authorUsername)} ¬∑ ${formatTime(c.createdAt)}</span>
                    <div style="margin-top:4px;font-size:0.93rem;line-height:1.5;">${esc(c.text)}</div>
                </div>
            </div>
        `).join('')
    }

    container.innerHTML = html
}

async function sendWallPost(targetUid) {
    if (!currentUser || !currentUserData) return
    const input = document.getElementById('wallInput')
    const text = input.value.trim()
    if (!text) return
    input.value = ''

    await db.ref(`social_walls/${targetUid}`).push({
        text,
        authorUid: currentUser.uid,
        authorName: currentUserData.name || currentUserData.username,
        authorUsername: currentUserData.username,
        authorAvatar: currentUserData.avatar || '',
        createdAt: Date.now(),
    })
    loadWall(targetUid)
    showToast('‚úÖ –ù–∞–ø–∏—Å–∞–Ω–æ –Ω–∞ —Å—Ç–µ–Ω–µ!')
}

async function loadLikedPosts(uid) {
    const container = document.getElementById('profilePostsContainer')
    container.innerHTML = '<div class="feed-loading"><div class="spinner-small"></div></div>'
    // For liked posts, we'd need a separate index ‚Äî simplified: show empty for now
    container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ù§Ô∏è</div><div class="empty-state-title">–õ–∞–π–∫–Ω—É—Ç—ã–µ –ø–æ—Å—Ç—ã</div><div class="empty-state-sub">–°–∫–æ—Ä–æ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ</div></div>'
}

// ===== EDIT PROFILE =====
async function saveProfile() {
    if (!currentUser || !currentUserData) return
    const name = document.getElementById('editName').value.trim()
    const bio = document.getElementById('editBio').value.trim()
    const avatar = document.getElementById('editAvatar').value.trim()

    await db.ref(`social_users/${currentUser.uid}`).update({ name, bio, avatar })
    currentUserData = { ...currentUserData, name, bio, avatar }
    updateSidebar()
    if (currentUserData.avatar) document.getElementById('composerAvatar').src = currentUserData.avatar
    closeModal('editProfileModal')
    loadProfile(currentUser.uid)
    showToast('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω!')
}

// ===== FOLLOW LIST =====
async function openFollowList(type) {
    const title = type === 'following' ? '–ü–æ–¥–ø–∏—Å–∫–∏' : '–ü–æ–¥–ø–∏—Å—á–∏–∫–∏'
    document.getElementById('followListTitle').textContent = title
    const body = document.getElementById('followListBody')
    body.innerHTML = '<div class="feed-loading"><div class="spinner-small"></div></div>'
    openModal('followListModal')

    const uid = viewingUid || currentUser?.uid
    if (!uid) { body.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text2);">–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</div>'; return; }

    try {
        let userUids = []
        if (type === 'following') {
            // people this user follows
            const snap = await db.ref(`social_follows/${uid}`).once('value')
            snap.forEach(c => userUids.push(c.key))
        } else {
            // people who follow this user ‚Äî scan all follows
            const snap = await db.ref('social_follows').once('value')
            snap.forEach(followerNode => {
                if (followerNode.child(uid).exists()) userUids.push(followerNode.key)
            })
        }

        if (!userUids.length) {
            body.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üë§</div><div class="empty-state-title">–ü—É—Å—Ç–æ</div></div>`
            return
        }

        const users = await Promise.all(userUids.map(async uid2 => {
            const s = await db.ref(`social_users/${uid2}`).once('value')
            return s.exists() ? { uid: uid2, ...s.val() } : null
        }))

        body.innerHTML = users.filter(Boolean).map(u => `
            <div class="suggest-user" style="padding:12px 16px;cursor:pointer;border-bottom:1px solid var(--border);" onclick="closeModal('followListModal');showProfile('${u.uid}')">
                <div class="suggest-avatar">${u.avatar ? `<img src="${u.avatar}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : 'ü§°'}</div>
                <div class="suggest-info">
                    <div class="suggest-name">${esc(u.name || u.username)}</div>
                    <div class="suggest-handle">@${esc(u.username)}</div>
                </div>
            </div>
        `).join('')
    } catch(e) {
        body.innerHTML = `<div style="padding:20px;text-align:center;color:var(--text2);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>`
    }
}

// ===== FOLLOW =====
async function toggleFollow() {
    if (!currentUser) { showToast('–í–æ–π–¥–∏—Ç–µ —á—Ç–æ–±—ã –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'); return; }
    const btn = document.getElementById('profileFollowBtn')
    const targetUid = btn.dataset.targetUid
    if (!targetUid) return

    const ref = db.ref(`social_follows/${currentUser.uid}/${targetUid}`)
    const snap = await ref.once('value')
    const isFollowing = snap.exists()

    if (isFollowing) {
        await ref.remove()
        db.ref(`social_users/${targetUid}`).transaction(u => { if (u) u.followers = Math.max(0, (u.followers||0)-1); return u })
        db.ref(`social_users/${currentUser.uid}`).transaction(u => { if (u) u.following = Math.max(0, (u.following||0)-1); return u })
        btn.textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è'
        btn.className = 'follow-btn'
        showToast('–û—Ç–ø–∏—Å–∞–ª—Å—è')
    } else {
        await ref.set(true)
        db.ref(`social_users/${targetUid}`).transaction(u => { if (u) u.followers = (u.followers||0)+1; return u })
        db.ref(`social_users/${currentUser.uid}`).transaction(u => { if (u) u.following = (u.following||0)+1; return u })
        btn.textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è'
        btn.className = 'follow-btn following'
        showToast('‚úÖ –ü–æ–¥–ø–∏—Å–∞–ª—Å—è!')
    }
    loadProfile(targetUid)
}

// ===== SEARCH =====
async function doSearch(query) {
    const container = document.getElementById('searchResults')
    if (!query.trim()) {
        container.innerHTML = `<div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div class="empty-state-title">–ù–∞–π–¥–∏ –∫–æ–≥–æ-–Ω–∏–±—É–¥—å</div>
        </div>`
        return
    }
    container.innerHTML = '<div class="feed-loading"><div class="spinner-small"></div></div>'
    const snap = await db.ref('social_users').once('value')
    const results = []
    const q = query.toLowerCase()
    snap.forEach(c => {
        const u = c.val()
        if ((u.username && u.username.includes(q)) || (u.name && u.name.toLowerCase().includes(q))) {
            results.push({ uid: c.key, ...u })
        }
    })

    if (!results.length) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòï</div><div class="empty-state-title">–ù–∏–∫–æ–≥–æ –Ω–µ –Ω–∞—à–ª–∏</div></div>'
        return
    }

    container.innerHTML = results.map(u => `
        <div class="suggest-user" style="padding:12px 16px;cursor:pointer;" onclick="showProfile('${u.uid}')">
            <div class="suggest-avatar">${u.avatar ? `<img src="${u.avatar}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : 'ü§°'}</div>
            <div class="suggest-info">
                <div class="suggest-name">${esc(u.name || u.username)}</div>
                <div class="suggest-handle">@${esc(u.username)}</div>
            </div>
        </div>
    `).join('')
}

// ===== SUGGESTED USERS =====
async function loadSuggestedUsers() {
    const container = document.getElementById('suggestedUsers')
    const snap = await db.ref('social_users').limitToLast(5).once('value')
    const users = []
    snap.forEach(c => {
        if (c.key !== currentUser?.uid) users.push({ uid: c.key, ...c.val() })
    })
    if (!users.length) { container.innerHTML = '<div style="color:var(--text2);font-size:0.85rem;">–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç</div>'; return; }
    container.innerHTML = users.map(u => `
        <div class="suggest-user">
            <div class="suggest-avatar">${u.avatar ? `<img src="${u.avatar}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : 'ü§°'}</div>
            <div class="suggest-info">
                <div class="suggest-name">${esc(u.name || u.username)}</div>
                <div class="suggest-handle">@${esc(u.username)}</div>
            </div>
            <button class="follow-btn" onclick="showProfile('${u.uid}')">–°–º–æ—Ç—Ä–µ—Ç—å</button>
        </div>
    `).join('')
}

// ===== MODAL =====
function openModal(id) { document.getElementById(id).classList.add('open') }
function closeModal(id) {
    document.getElementById(id).classList.remove('open')
    if (id === 'postDetailModal' && commentsListener && commentsListenerPostId) {
        db.ref(`social_comments/${commentsListenerPostId}`).off('value', commentsListener)
        commentsListener = null
        commentsListenerPostId = null
    }
}
document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open') })
})

// ===== HELPERS =====
function esc(str) {
    if (!str) return ''
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')
}

function formatTime(ts) {
    if (!ts) return ''
    const diff = Date.now() - ts
    if (diff < 60000) return '—Å–µ–π—á–∞—Å'
    if (diff < 3600000) return Math.floor(diff/60000) + ' –º–∏–Ω'
    if (diff < 86400000) return Math.floor(diff/3600000) + ' —á'
    if (diff < 604800000) return Math.floor(diff/86400000) + ' –¥–Ω'
    return new Date(ts).toLocaleDateString('ru')
}

function showToast(msg) {
    const t = document.getElementById('toast')
    t.textContent = msg
    t.classList.add('show')
    setTimeout(() => t.classList.remove('show'), 2500)
}

// ===== CHAT =====
let socialChatRef = null
let socialChatLoaded = false

function showChat() {
    setNavActive('navChat')
    document.getElementById('feedView').style.display = 'none'
    document.getElementById('profileView').style.display = 'none'
    document.getElementById('searchView').style.display = 'none'
    document.getElementById('adminView').style.display = 'none'
    document.getElementById('chatView').style.display = 'flex'
    document.getElementById('chatView').style.flexDirection = 'column'
    if (currentUser && currentUserData) {
        if (currentUserData.avatar) document.getElementById('socialChatAvatar').src = currentUserData.avatar
    }
    if (!socialChatLoaded) {
        loadSocialChat()
        socialChatLoaded = true
    }
}

function loadSocialChat() {
    const container = document.getElementById('socialChatMessages')
    if (!container) return

    // Detach old listener
    if (socialChatRef) {
        socialChatRef.off()
        socialChatRef = null
    }

    container.innerHTML = '<div style="text-align:center;color:var(--text2);padding:20px;font-size:0.85rem;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>'

    // Load last 100 messages, then listen for all new ones via child_added
    socialChatRef = db.ref('messages').orderByChild('timestamp').limitToLast(100)

    const renderedKeys = new Set()
    let initialLoadDone = false

    socialChatRef.once('value', snap => {
        container.innerHTML = ''
        snap.forEach(child => {
            const msg = { key: child.key, ...child.val() }
            renderedKeys.add(msg.key)
            appendSocialChatMsg(msg, container, false)
        })
        initialLoadDone = true
        container.scrollTop = container.scrollHeight

        // Live listener for new messages
        socialChatRef.on('child_added', snap => {
            if (!initialLoadDone) return
            if (renderedKeys.has(snap.key)) return
            renderedKeys.add(snap.key)
            const msg = { key: snap.key, ...snap.val() }
            appendSocialChatMsg(msg, container, true)
        })
    })
}

// Cache for social user profiles
const socialUserCache = {}

async function getSocialUser(uid) {
    if (!uid) return null
    if (socialUserCache[uid]) return socialUserCache[uid]
    try {
        const snap = await db.ref(`social_users/${uid}`).once('value')
        const data = snap.exists() ? snap.val() : null
        socialUserCache[uid] = data
        return data
    } catch(e) { return null }
}

function appendSocialChatMsg(msg, container, scroll) {
    if (!msg || container.querySelector(`[data-msg-id="${msg.key}"]`)) return

    const isMe = currentUser && msg.uid === currentUser.uid
    const time = new Date(msg.timestamp || Date.now()).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
    const avatarChar = (msg.username || '?').charAt(0).toUpperCase()

    const div = document.createElement('div')
    div.dataset.msgId = msg.key
    div.style.cssText = `display:flex;gap:10px;align-items:flex-start;${isMe ? 'flex-direction:row-reverse;' : ''}`

    const bubbleColor = isMe ? 'var(--accent)' : 'var(--bg3)'
    const bubbleTextColor = isMe ? '#fff' : 'var(--text)'
    const align = isMe ? 'right' : 'left'

    let content = ''
    if (msg.text) content += `<div style="font-size:0.92rem;line-height:1.5;word-break:break-word;">${esc(msg.text)}</div>`
    if (msg.image) content += `<img src="${msg.image}" style="max-width:220px;border-radius:10px;margin-top:4px;cursor:zoom-in;" onclick="openLightbox(0, JSON.stringify(['${msg.image}']))" loading="lazy">`
    if (msg.voice) content += buildVoicePlayerWidget(msg.voice, msg.duration||0, isMe)

    // Placeholder avatar while loading social profile
    const avatarId = `av-${msg.key}`
    const nameId = `nm-${msg.key}`

    // Use msg.avatar if available for instant display
    const avatarHtml = msg.uid
        ? `<div id="${avatarId}" style="
            width:36px;height:36px;border-radius:50%;
            background:${isMe ? 'var(--accent)' : 'var(--bg4)'};
            display:flex;align-items:center;justify-content:center;
            font-size:0.88rem;font-weight:700;color:#fff;flex-shrink:0;
            cursor:pointer;overflow:hidden;
          " onclick="showProfile('${msg.uid}')">${msg.avatar
            ? `<img src="${msg.avatar}" style="width:36px;height:36px;object-fit:cover;border-radius:50%;display:block;" onerror="this.parentElement.innerHTML='${avatarChar}'">`
            : avatarChar}</div>`
        : `<div style="
            width:36px;height:36px;border-radius:50%;
            background:var(--bg4);
            display:flex;align-items:center;justify-content:center;
            font-size:0.88rem;font-weight:700;color:#fff;flex-shrink:0;
          ">${avatarChar}</div>`

    const usernameHtml = `<div id="${nameId}" style="font-size:0.75rem;color:var(--text2);margin-bottom:3px;text-align:${align};cursor:pointer;" onclick="showProfile('${msg.uid}')">${esc(msg.username || '–ì–æ—Å—Ç—å')}</div>`

    div.innerHTML = avatarHtml + `<div style="max-width:75%;">
        ${!isMe ? usernameHtml : ''}
        <div style="
            background:${bubbleColor};
            color:${bubbleTextColor};
            border-radius:${isMe ? '18px 18px 4px 18px' : '18px 18px 18px 4px'};
            padding:8px 14px;
            font-size:0.92rem;
        ">${content}</div>
        <div style="font-size:0.72rem;color:var(--text2);margin-top:3px;text-align:${align};">${time}</div>
    </div>`

    container.appendChild(div)
    if (scroll) container.scrollTop = container.scrollHeight

    // Async: load social profile and update avatar + username
    if (msg.uid) {
        getSocialUser(msg.uid).then(profile => {
            if (!profile) return
            const avEl = document.getElementById(avatarId)
            const nmEl = document.getElementById(nameId)
            if (avEl && profile.avatar) {
                // Replace div content with actual image
                avEl.style.background = 'transparent'
                avEl.innerHTML = ''
                const img = document.createElement('img')
                img.src = profile.avatar
                img.style.cssText = 'width:36px;height:36px;object-fit:cover;border-radius:50%;display:block;'
                img.onerror = () => { avEl.style.background = isMe ? 'var(--accent)' : 'var(--bg4)'; avEl.innerHTML = avatarChar }
                avEl.appendChild(img)
            }
            if (nmEl) {
                nmEl.textContent = profile.name || profile.username || msg.username || '–ì–æ—Å—Ç—å'
            }
        }).catch(() => {})
    }
}

function autoResizeSocialChat(el) {
    el.style.height = 'auto'
    el.style.height = Math.min(el.scrollHeight, 120) + 'px'
}

function handleSocialChatKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault()
        sendSocialChatMessage()
    }
}

async function sendSocialChatMessage() {
    if (!currentUser || !currentUserData) { showToast('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–∏—Å–∞—Ç—å'); return; }
    const input = document.getElementById('socialChatInput')
    const text = input.value.trim()
    const photo = window._chatPendingPhoto || null

    if (!text && !photo) return

    input.value = ''
    input.style.height = 'auto'

    try {
        const msgObj = {
            uid: currentUser.uid,
            username: currentUserData.name || currentUserData.username,
            avatar: currentUserData.avatar || currentUser.photoURL || '',
            timestamp: Date.now(),
        }
        if (text) msgObj.text = text

        if (photo) {
            // Upload photo to Firebase Storage
            const sendBtn = document.querySelector('#socialChatInputArea button[onclick="sendSocialChatMessage()"]')
            if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = '‚è≥' }
            try {
                const ref = storage.ref(`chat_photos/${currentUser.uid}_${Date.now()}.jpg`)
                await ref.put(photo)
                msgObj.image = await ref.getDownloadURL()
            } finally {
                if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = '‚û§' }
            }
            window._chatPendingPhoto = null
            clearChatPhotoPreview()
        }

        await db.ref('messages').push(msgObj)
    } catch(e) {
        showToast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + e.message)
        input.value = text
    }
}



// ===== VOICE WIDGET BUILDER =====
function buildVoicePlayerWidget(url, duration, isMe) {
    const uid = 'vp_' + Math.random().toString(36).slice(2)
    const bars = Array.from({length: 16}, (_, i) => {
        const h = 5 + Math.round(Math.abs(Math.sin(i * 0.8 + 0.5)) * 14 + Math.random() * 4)
        return `<span style="display:inline-block;width:3px;height:${h}px;background:${isMe ? 'rgba(255,255,255,0.65)' : 'var(--accent)'};border-radius:2px;margin:0 1px;"></span>`
    }).join('')
    const m = Math.floor(duration/60), s = duration%60
    const durStr = duration ? `${m}:${String(s).padStart(2,'0')}` : '0:00'
    return `<div onclick="event.stopPropagation()" style="display:flex;align-items:center;gap:8px;padding:4px 0;min-width:180px;">
        <button onclick="toggleVoicePlay('${uid}','${url}',this)" id="${uid}_btn" style="
            width:32px;height:32px;border-radius:50%;
            background:${isMe?'rgba(255,255,255,0.25)':'var(--accent)'};
            border:none;color:#fff;font-size:0.85rem;cursor:pointer;flex-shrink:0;
            display:flex;align-items:center;justify-content:center;">‚ñ∂</button>
        <div style="display:flex;align-items:center;gap:1px;">${bars}</div>
        <span style="font-size:0.72rem;color:${isMe?'rgba(255,255,255,0.7)':'var(--text2)'};white-space:nowrap;">${durStr}</span>
        <audio id="${uid}" src="${url}" onended="document.getElementById('${uid}_btn').textContent='‚ñ∂'" style="display:none;"></audio>
    </div>`
}

function toggleVoicePlay(id, url, btn) {
    const audio = document.getElementById(id)
    if (!audio) return
    if (audio.paused) {
        document.querySelectorAll('audio').forEach(a => { if (a !== audio) { a.pause(); const b = document.getElementById(a.id + '_btn'); if(b) b.textContent = '‚ñ∂' } })
        audio.play()
        btn.textContent = '‚è∏'
    } else {
        audio.pause()
        btn.textContent = '‚ñ∂'
    }
}

// ===== VOICE FOR POST =====
window._voicePostBlob = null
window._voicePostDuration = 0
let _voicePostRecorder = null
let _voicePostTimer = null
let _voicePostSec = 0

async function toggleVoicePost() {
    if (!currentUser) { showToast('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å'); return }
    if (_voicePostRecorder && _voicePostRecorder.state === 'recording') {
        _voicePostRecorder.stop()
        return
    }
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
        _voicePostSec = 0
        window._voicePostBlob = null
        const chunks = []
        _voicePostRecorder = new MediaRecorder(stream)
        _voicePostRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data) }
        _voicePostRecorder.onstop = () => {
            stream.getTracks().forEach(t => t.stop())
            clearInterval(_voicePostTimer)
            document.getElementById('voicePostBtn').style.color = ''
            document.getElementById('voicePostPreviewBar').style.display = 'none'
            if (chunks.length) {
                window._voicePostBlob = new Blob(chunks, { type: 'audio/webm' })
                window._voicePostDuration = _voicePostSec
                const url = URL.createObjectURL(window._voicePostBlob)
                const attached = document.getElementById('voicePostAttachedBar')
                attached.style.display = 'flex'
                document.getElementById('voicePostAudioEl').src = url
            }
        }
        _voicePostRecorder.start(250)
        document.getElementById('voicePostBtn').style.color = 'var(--danger)'
        document.getElementById('voicePostPreviewBar').style.display = 'flex'
        document.getElementById('voicePostAttachedBar').style.display = 'none'
        _voicePostTimer = setInterval(() => {
            _voicePostSec++
            const m = Math.floor(_voicePostSec/60), s = _voicePostSec%60
            document.getElementById('voicePostTimer').textContent = `‚óè ${m}:${String(s).padStart(2,'0')}`
            if (_voicePostSec >= 120) _voicePostRecorder.stop()
        }, 1000)
    } catch(e) {
        showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + e.message)
    }
}

function stopVoicePost(keep) {
    if (!keep) {
        if (_voicePostRecorder) { try { _voicePostRecorder.stop() } catch(e){} }
        setTimeout(() => {
            window._voicePostBlob = null
            document.getElementById('voicePostPreviewBar').style.display = 'none'
            document.getElementById('voicePostAttachedBar').style.display = 'none'
        }, 100)
    } else {
        if (_voicePostRecorder) { try { _voicePostRecorder.stop() } catch(e){} }
    }
}

function cancelVoicePost() {
    window._voicePostBlob = null
    window._voicePostDuration = 0
    document.getElementById('voicePostAttachedBar').style.display = 'none'
    const el = document.getElementById('voicePostAudioEl')
    if (el) { el.pause(); el.src = '' }
}

// ===== VOICE FOR CHAT =====
let _voiceChatRecorder = null
let _voiceChatTimer = null
let _voiceChatSec = 0
let _voiceChatRecording = false

async function toggleVoiceChat() {
    if (!currentUser || !currentUserData) { showToast('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å'); return }
    if (_voiceChatRecording) {
        if (_voiceChatRecorder) _voiceChatRecorder.stop()
        return
    }
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
        _voiceChatSec = 0
        _voiceChatRecording = true
        const chunks = []
        _voiceChatRecorder = new MediaRecorder(stream)
        const btn = document.getElementById('voiceChatBtn')
        btn.style.color = 'var(--danger)'

        _voiceChatRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data) }
        _voiceChatRecorder.onstop = async () => {
            stream.getTracks().forEach(t => t.stop())
            clearInterval(_voiceChatTimer)
            _voiceChatRecording = false
            btn.style.color = ''
            btn.disabled = false
            const timerEl = document.getElementById('voiceChatTimer')
            if (timerEl) timerEl.remove()
            if (!chunks.length) return
            const blob = new Blob(chunks, { type: 'audio/webm' })
            btn.disabled = true
            btn.style.opacity = '0.5'
            try {
                const base64Voice = await new Promise((resolve, reject) => {
                    const reader = new FileReader()
                    reader.onload = () => resolve(reader.result)
                    reader.onerror = reject
                    reader.readAsDataURL(blob)
                })
                await db.ref('messages').push({
                    voice: base64Voice,
                    duration: _voiceChatSec,
                    uid: currentUser.uid,
                    username: currentUserData.name || currentUserData.username,
                    avatar: currentUserData.avatar || currentUser.photoURL || '',
                    timestamp: Date.now(),
                })
                showToast('üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!')
            } catch(e) {
                showToast('–û—à–∏–±–∫–∞: ' + e.message)
            } finally {
                btn.disabled = false
                btn.style.opacity = ''
            }
        }

        _voiceChatRecorder.start(250)
        // Add a timer label next to the button
        const timerLabel = document.createElement('span')
        timerLabel.id = 'voiceChatTimer'
        timerLabel.style.cssText = 'font-size:0.75rem;color:var(--danger);font-weight:700;min-width:36px;'
        timerLabel.textContent = '0:00'
        btn.parentNode.insertBefore(timerLabel, btn.nextSibling)
        _voiceChatTimer = setInterval(() => {
            _voiceChatSec++
            const m = Math.floor(_voiceChatSec/60), s = _voiceChatSec%60
            const tEl = document.getElementById('voiceChatTimer')
            if (tEl) tEl.textContent = `${m}:${String(s).padStart(2,'0')}`
            if (_voiceChatSec >= 120) _voiceChatRecorder.stop()
        }, 1000)
    } catch(e) {
        _voiceChatRecording = false
        showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + e.message)
    }
}

// Show admin button when correct user logs in
auth.onAuthStateChanged(user => {
    const btn = document.getElementById('navAdmin')
    if (btn) btn.style.display = (user && user.email === ADMIN_EMAIL) ? 'flex' : 'none'
})

// ===== PHOTO LIGHTBOX =====
let _lbPhotos = []
let _lbIndex = 0

function openLightbox(index, photosJson) {
    try {
        _lbPhotos = typeof photosJson === 'string' ? JSON.parse(photosJson) : photosJson
    } catch(e) { _lbPhotos = [photosJson] }
    _lbIndex = index
    _updateLightbox()
    const lb = document.getElementById('photoLightbox')
    lb.style.display = 'flex'
    document.body.style.overflow = 'hidden'
    document.addEventListener('keydown', _lbKeyHandler)
}

function openLightboxByKey(index, postKey) {
    const photos = (window._postPhotosRegistry || {})[postKey]
    if (!photos) { console.warn('openLightboxByKey: no photos for key', postKey); return }
    openLightbox(index, photos)
}

function _updateLightbox() {
    document.getElementById('lightboxImg').src = _lbPhotos[_lbIndex]
    const multi = _lbPhotos.length > 1
    document.getElementById('lbPrev').style.display = multi ? 'flex' : 'none'
    document.getElementById('lbNext').style.display = multi ? 'flex' : 'none'
    document.getElementById('lbCounter').textContent = multi ? `${_lbIndex + 1} / ${_lbPhotos.length}` : ''
}

function lightboxNav(dir) {
    _lbIndex = (_lbIndex + dir + _lbPhotos.length) % _lbPhotos.length
    _updateLightbox()
}

function closeLightbox() {
    document.getElementById('photoLightbox').style.display = 'none'
    document.body.style.overflow = ''
    document.removeEventListener('keydown', _lbKeyHandler)
}

function _lbKeyHandler(e) {
    if (e.key === 'Escape') closeLightbox()
    else if (e.key === 'ArrowLeft') lightboxNav(-1)
    else if (e.key === 'ArrowRight') lightboxNav(1)
}

// ===== CHAT PHOTO =====
window._chatPendingPhoto = null

function handleChatPhotoSelect(e) {
    const file = e.target.files[0]
    if (!file) return
    e.target.value = ''
    window._chatPendingPhoto = file
    const url = URL.createObjectURL(file)
    const row = document.getElementById('chatPhotoPreviewRow')
    row.style.display = 'flex'
    row.innerHTML = `
        <div style="position:relative;display:inline-block;">
            <img src="${url}" style="height:80px;border-radius:10px;object-fit:cover;cursor:zoom-in;" onclick="openLightbox(0, JSON.stringify(['${url}']))">
            <button onclick="clearChatPhotoPreview()" style="position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;border:none;border-radius:50%;width:20px;height:20px;font-size:0.75rem;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;">‚úï</button>
        </div>
    `
}

function clearChatPhotoPreview() {
    window._chatPendingPhoto = null
    const row = document.getElementById('chatPhotoPreviewRow')
    if (row) { row.style.display = 'none'; row.innerHTML = '' }
}

// ===== FIX: —Å–ª–µ–¥–∏–º –∑–∞ —Ä–µ–∞–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º –ø–æ–¥–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ real-time listener =====
function watchFollowCounts(uid) {
    // Watch following count (lightweight - only this user's node)
    db.ref(`social_follows/${uid}`).on('value', snap => {
        const el = document.getElementById('profileFollowing')
        if (el) el.textContent = snap.numChildren()
    })
    // Followers: do NOT use .on() on all social_follows ‚Äî it fires before all data is loaded
    // Instead do a one-time count now, and refresh after toggle actions
    refreshFollowersCount(uid)
}

async function refreshFollowersCount(uid) {
    if (!uid) return
    const snap = await db.ref('social_follows').once('value')
    let count = 0
    snap.forEach(node => { if (node.child(uid).exists()) count++ })
    const el = document.getElementById('profileFollowers')
    if (el) el.textContent = count
}

// ===== ADMIN PANEL JS =====
function showAdmin() {
    if (!currentUser || currentUser.email !== ADMIN_EMAIL) { showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'); return }
    setNavActive('navAdmin')
    document.getElementById('feedView').style.display = 'none'
    document.getElementById('profileView').style.display = 'none'
    document.getElementById('searchView').style.display = 'none'
    document.getElementById('chatView').style.display = 'none'
    document.getElementById('adminView').style.display = 'block'
    loadAdminTab('stats')
}

let _currentAdminTab = 'stats'
const _adminTabIds = { stats: 'atab-stats', users: 'atab-users', posts: 'atab-posts', chat: 'atab-chat' }

function switchAdminTab(tab) {
    _currentAdminTab = tab
    Object.entries(_adminTabIds).forEach(([t, id]) => {
        const el = document.getElementById(id)
        if (el) el.className = 'admin-tab' + (t===tab?' active':'')
    })
    loadAdminTab(tab)
}

async function loadAdminTab(tab) {
    const content = document.getElementById('adminContent')
    if (!content) return
    content.innerHTML = '<div class="feed-loading"><div class="spinner-small"></div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>'
    try {
        if (tab === 'stats') await renderAdminStats(content)
        else if (tab === 'users') await renderAdminUsers(content)
        else if (tab === 'posts') await renderAdminPosts(content)
        else if (tab === 'chat') await renderAdminChat(content)
    } catch(e) {
        content.innerHTML = `<div style="padding:20px;color:var(--danger);">–û—à–∏–±–∫–∞: ${e.message}</div>`
    }
}

async function renderAdminStats(content) {
    const [usersSnap, postsSnap, messSnap, followsSnap] = await Promise.all([
        db.ref('social_users').once('value'),
        db.ref('social_posts').once('value'),
        db.ref('messages').once('value'),
        db.ref('social_follows').once('value'),
    ])
    let voicePostCount = 0
    postsSnap.forEach(c => { if (c.val().voice) voicePostCount++ })
    let voiceMsgCount = 0
    messSnap.forEach(c => { if (c.val().voice) voiceMsgCount++ })
    content.innerHTML = `
        <div style="padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div style="background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:center;">
                <div style="font-size:2rem;font-weight:800;color:var(--accent);">${usersSnap.numChildren()}</div>
                <div style="color:var(--text2);font-size:0.85rem;margin-top:4px;">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
            </div>
            <div style="background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:center;">
                <div style="font-size:2rem;font-weight:800;color:var(--accent);">${postsSnap.numChildren()}</div>
                <div style="color:var(--text2);font-size:0.85rem;margin-top:4px;">üìù –ü–æ—Å—Ç–æ–≤</div>
            </div>
            <div style="background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:center;">
                <div style="font-size:2rem;font-weight:800;color:var(--green);">${voicePostCount}</div>
                <div style="color:var(--text2);font-size:0.85rem;margin-top:4px;">üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã—Ö –ø–æ—Å—Ç–æ–≤</div>
            </div>
            <div style="background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:center;">
                <div style="font-size:2rem;font-weight:800;color:var(--gold);">${messSnap.numChildren()}</div>
                <div style="color:var(--text2);font-size:0.85rem;margin-top:4px;">üí¨ –°–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ</div>
            </div>
            <div style="background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:18px;text-align:center;grid-column:span 2;">
                <div style="font-size:2rem;font-weight:800;color:var(--accent2);">${voiceMsgCount}</div>
                <div style="color:var(--text2);font-size:0.85rem;margin-top:4px;">üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤—ã—Ö –≤ —á–∞—Ç–µ</div>
            </div>
        </div>
    `
}

async function renderAdminUsers(content) {
    const snap = await db.ref('social_users').once('value')
    const users = []
    snap.forEach(c => users.push({ uid: c.key, ...c.val() }))
    users.sort((a,b) => (b.createdAt||0)-(a.createdAt||0))
    if (!users.length) { content.innerHTML = '<div style="padding:20px;color:var(--text2);text-align:center;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>'; return }
    content.innerHTML = `
        <div style="padding:12px 16px;">
            <input type="text" placeholder="–ü–æ–∏—Å–∫..." oninput="adminFilterUsersInline(this.value, this)" style="width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:9px 14px;font-size:0.9rem;font-family:Inter,sans-serif;outline:none;">
        </div>
        <div id="adminUsersListInner">${renderAdminUsersList(users)}</div>
    `
    content._adminUsers = users
}

function renderAdminUsersList(users) {
    return users.map(u => `
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);">
            <div style="width:40px;height:40px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;font-size:1.2rem;">
                ${u.avatar ? `<img src="${u.avatar}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;">` : 'ü§°'}
            </div>
            <div style="flex:1;min-width:0;">
                <div style="font-weight:600;font-size:0.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(u.name||u.username||'‚Äî')}</div>
                <div style="color:var(--text2);font-size:0.78rem;">@${esc(u.username||'‚Äî')} ¬∑ ${new Date(u.createdAt||0).toLocaleDateString('ru')}</div>
            </div>
            <div style="display:flex;gap:6px;flex-shrink:0;">
                <button onclick="showAdmin();showProfile('${u.uid}')" style="background:var(--bg4);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:5px 10px;font-size:0.78rem;cursor:pointer;">–ü—Ä–æ—Ñ–∏–ª—å</button>
                <button onclick="adminBanUser('${u.uid}','${esc(u.name||u.username)}')" style="background:rgba(244,33,46,0.1);border:1px solid var(--danger);color:var(--danger);border-radius:8px;padding:5px 10px;font-size:0.78rem;cursor:pointer;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    `).join('')
}

function adminFilterUsersInline(q, input) {
    const all = document.getElementById('adminContent')._adminUsers || []
    const f = q ? all.filter(u => ((u.name||'')+(u.username||'')).toLowerCase().includes(q.toLowerCase())) : all
    document.getElementById('adminUsersListInner').innerHTML = renderAdminUsersList(f)
}

async function adminBanUser(uid, name) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${name}?\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—å. –ü–æ—Å—Ç—ã –æ—Å—Ç–∞–Ω—É—Ç—Å—è.`)) return
    await db.ref(`social_users/${uid}`).remove()
    showToast('‚úÖ –£–¥–∞–ª–µ–Ω–æ')
    loadAdminTab('users')
}

async function renderAdminPosts(content) {
    const snap = await db.ref('social_posts').orderByChild('createdAt').limitToLast(100).once('value')
    const posts = []
    snap.forEach(c => posts.push({ id: c.key, ...c.val() }))
    posts.reverse()
    content.innerHTML = `
        <div style="padding:12px 16px;color:var(--text2);font-size:0.85rem;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ ${posts.length} –ø–æ—Å—Ç–æ–≤</div>
        ${posts.map(p => `
            <div style="display:flex;align-items:flex-start;gap:12px;padding:12px 16px;border-bottom:1px solid var(--border);">
                <div style="flex:1;min-width:0;">
                    <div style="font-size:0.78rem;color:var(--text2);margin-bottom:4px;">@${esc(p.authorUsername||'‚Äî')} ¬∑ ${new Date(p.createdAt||0).toLocaleDateString('ru')}</div>
                    ${p.voice ? `<div style="display:flex;align-items:center;gap:6px;color:var(--green);font-size:0.85rem;">üéôÔ∏è <audio src="${p.voice}" controls style="height:26px;max-width:180px;"></audio></div>` : ''}
                    ${p.text ? `<div style="font-size:0.9rem;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;">${esc(p.text)}</div>` : ''}
                    ${p.photos && p.photos[0] ? `<img src="${p.photos[0]}" style="height:48px;border-radius:6px;margin-top:4px;object-fit:cover;">` : ''}
                </div>
                <button onclick="adminDeletePost('${p.id}')" style="background:rgba(244,33,46,0.1);border:1px solid var(--danger);color:var(--danger);border-radius:8px;padding:5px 10px;font-size:0.78rem;cursor:pointer;flex-shrink:0;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `).join('')}
    `
}

async function adminDeletePost(postId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return
    await db.ref(`social_posts/${postId}`).remove()
    showToast('‚úÖ –ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω')
    loadAdminTab('posts')
}

async function renderAdminChat(content) {
    const snap = await db.ref('messages').orderByChild('timestamp').limitToLast(50).once('value')
    const msgs = []
    snap.forEach(c => msgs.push({ id: c.key, ...c.val() }))
    msgs.reverse()
    content.innerHTML = `
        <div style="padding:12px 16px;color:var(--text2);font-size:0.85rem;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ ${msgs.length} —Å–æ–æ–±—â–µ–Ω–∏–π</div>
        ${msgs.map(m => `
            <div style="display:flex;align-items:flex-start;gap:12px;padding:10px 16px;border-bottom:1px solid var(--border);">
                <div style="flex:1;min-width:0;">
                    <div style="font-size:0.78rem;color:var(--text2);margin-bottom:3px;">${esc(m.username||'‚Äî')} ¬∑ ${new Date(m.timestamp||0).toLocaleTimeString('ru')}</div>
                    ${m.voice ? `<div style="display:flex;align-items:center;gap:6px;color:var(--green);font-size:0.85rem;">üéôÔ∏è <audio src="${m.voice}" controls style="height:26px;max-width:180px;"></audio></div>` : ''}
                    ${m.text ? `<div style="font-size:0.88rem;">${esc(m.text)}</div>` : ''}
                </div>
                <button onclick="adminDeleteChatMsg('${m.id}')" style="background:rgba(244,33,46,0.1);border:1px solid var(--danger);color:var(--danger);border-radius:8px;padding:4px 8px;font-size:0.78rem;cursor:pointer;flex-shrink:0;">‚úï</button>
            </div>
        `).join('')}
    `
}

async function adminDeleteChatMsg(msgId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return
    await db.ref(`messages/${msgId}`).remove()
    showToast('üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ')
    loadAdminTab('chat')
}


</script>
</body>
</html>